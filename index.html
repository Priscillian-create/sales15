<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Point of Sale System">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="POS System">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè™</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48cGF0aCBmaWxsPSIjMmMzZTUwIiBkPSJNMTQ4IDEyMGMwLTE3LjcgMTQuMy0zMiAzMi0zMnMzMiAxNC4zIDMyIDMyYzAgOC44LTMuNiAxNi43LTkuNCAyMi42bC0xMi4yIDEyLjJjLTIuOC0yLjgtNi42LTQuNC0xMC42LTQuNHMtNy44IDEuNi0xMC42IDQuNGwtMTIuMi0xMi4yYy01LjgtNS44LTkuNC0xMy44LTkuNC0yMi42IDAtMTcuNyAxNC4zLTMyIDMyLTMyMnMzMiAxNC4zIDMyIDMyYzAgOC44LTMuNiAxNi43LTkuNCAyMi42bDQuNiA0LjZjNS44IDUuOCAxNS4yIDUuOCAyMXMtNS44IDE1LjItNS44IDIxbC00LjYgNC42YzUuOCA1LjggMTMuOCA5LjQgMjIuNiA5LjQgMTcuNyAwIDMyLTE0LjMgMzItMzJ6TTE0OCAxMjBjMC04LjgtNy4yLTE2LTE2LTE2cy0xNiA3LjItMTYgMTYgNy4yIDE2IDE2IDE2IDE2LTcuMiAxNi0xNnoiLz48L3N2Zz4=">
    <title>Pa Gerrys Mart POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
    <style>
        :root { 
            --primary-color: #2c3e50; 
            --secondary-color: #3498db; 
            --accent-color: #e74c3c; 
            --success-color: #27ae60; 
            --light-color: #ecf0f1; 
            --dark-color: #2c3e50; 
            --gray-color: #95a5a6; 
            --warning-color: #f39c12; 
        } 
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        } 
        
        body { 
            background-color: #f5f7fa; 
            color: var(--dark-color); 
            overflow-x: hidden; 
        } 
        
        .container { 
            display: flex; 
            min-height: 100vh; 
        } 
        
        .sidebar { 
            width: 260px; 
            background-color: var(--primary-color); 
            color: white; 
            padding: 20px 0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
            z-index: 1000; 
            transition: transform 0.3s ease; 
        } 
        
        .sidebar.collapsed { 
            transform: translateX(-100%); 
        } 
        
        .logo { 
            text-align: center; 
            padding: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 20px; 
        } 
        
        .logo h1 { 
            font-size: 1.8rem; 
            margin-bottom: 5px; 
        } 
        
        .logo p { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .nav-menu { 
            list-style: none; 
        } 
        
        .nav-item { 
            margin-bottom: 5px; 
        } 
        
        .nav-link { 
            display: flex; 
            align-items: center; 
            padding: 12px 20px; 
            color: white; 
            text-decoration: none; 
            transition: all 0.3s; 
        } 
        
        .nav-link:hover, .nav-link.active { 
            background-color: rgba(255,255,255,0.1); 
            border-left: 3px solid var(--secondary-color); 
        } 
        
        .nav-link i { 
            margin-right: 10px; 
            width: 20px; 
            text-align: center; 
        } 
        
        .main-content { 
            flex: 1; 
            padding: 20px; 
            margin-left: 260px; 
            overflow-y: auto; 
            transition: margin-left 0.3s ease; 
        } 
        
        .main-content.expanded { 
            margin-left: 0; 
        } 
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #ddd; 
        } 
        
        .header h2 { 
            font-size: 1.8rem; 
            color: var(--primary-color); 
        } 
        
        .user-info { 
            display: flex; 
            align-items: center; 
        } 
        
        .user-info .user-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background-color: var(--secondary-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
            color: white; 
        } 
        
        .user-info span { 
            font-weight: 500; 
        } 
        
        .user-role { 
            background-color: var(--secondary-color); 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            margin-left: 8px; 
        } 
        
        .logout-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-left: 15px; 
            transition: background 0.3s; 
        } 
        
        .logout-btn:hover { 
            background: #c0392b; 
        } 
        
        .mobile-menu-btn { 
            display: none; 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 1.2rem; 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 1001; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        } 
        
        .pos-container { 
            display: grid; 
            grid-template-columns: 1fr 400px; 
            gap: 20px; 
        } 
        
        .products-section { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        } 
        
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        } 
        
        .section-header h3 { 
            font-size: 1.3rem; 
            color: var(--dark-color); 
        } 
        
        .search-bar { 
            display: flex; 
            margin-bottom: 20px; 
        } 
        
        .search-bar input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 4px 0 0 4px; 
            font-size: 1rem; 
        } 
        
        .search-bar button { 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            padding: 0 15px; 
            border-radius: 0 4px 4px 0; 
            cursor: pointer; 
        } 
        
        .products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
        } 
        
        .product-card { 
            border: 1px solid #eee; 
            border-radius: 8px; 
            padding: 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
        } 
        
        .product-card:hover { 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            transform: translateY(-3px); 
        } 
        
        .product-card .product-img { 
            height: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 10px; 
            background-color: #f9f9f9; 
            border-radius: 4px; 
        } 
        
        .product-card .product-img i { 
            font-size: 2.5rem; 
            color: var(--secondary-color); 
        } 
        
        .product-card h4 { 
            font-size: 0.9rem; 
            margin-bottom: 5px; 
        } 
        
        .product-card .price { 
            font-weight: 700; 
            color: var(--accent-color); 
        } 
        
        .product-card .stock { 
            font-size: 0.8rem; 
            color: var(--gray-color); 
        } 
        
        .product-card .expiry-warning { 
            font-size: 0.75rem; 
            color: var(--warning-color); 
            margin-top: 5px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        } 
        
        .product-card .expiry-warning i { 
            margin-right: 4px; 
        } 
        
        .cart-section { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            height: fit-content; 
        } 
        
        .cart-items { 
            margin-bottom: 20px; 
            max-height: 400px; 
            overflow-y: auto; 
        } 
        
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid #eee; 
        } 
        
        .cart-item:last-child { 
            border-bottom: none; 
        } 
        
        .cart-item-info { 
            flex: 1; 
        } 
        
        .cart-item-name { 
            font-weight: 500; 
        } 
        
        .cart-item-price { 
            color: var(--gray-color); 
            font-size: 0.9rem; 
        } 
        
        .cart-item-qty { 
            display: flex; 
            align-items: center; 
            margin-top: 5px; 
        } 
        
        .cart-item-qty button { 
            background: #f0f0f0; 
            border: none; 
            width: 24px; 
            height: 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
        } 
        
        .cart-item-qty button:hover {
            background: #e0e0e0;
        }
        
        .cart-item-qty input { 
            width: 40px; 
            text-align: center; 
            border: 1px solid #eee; 
            margin: 0 5px; 
        } 
        
        .cart-item-total { 
            font-weight: 700; 
            color: var(--dark-color); 
        } 
        
        .cart-summary { 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            margin-top: 15px; 
        } 
        
        .summary-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
        } 
        
        .summary-row.total { 
            font-weight: 700; 
            font-size: 1.1rem; 
            color: var(--dark-color); 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
        } 
        
        .cart-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 20px; 
        } 
        
        .btn { 
            padding: 12px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500; 
            text-align: center; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        } 
        
        .btn-primary { 
            background: var(--secondary-color); 
            color: white; 
        } 
        
        .btn-primary:hover { 
            background: #2980b9; 
        } 
        
        .btn-success { 
            background: var(--success-color); 
            color: white; 
        } 
        
        .btn-success:hover { 
            background: #229954; 
        } 
        
        .btn-danger { 
            background: var(--accent-color); 
            color: white; 
        } 
        
        .btn-danger:hover { 
            background: #c0392b; 
        } 
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid var(--gray-color); 
            color: var(--dark-color); 
        } 
        
        .btn-outline:hover { 
            background: #f0f0f0; 
        } 
        
        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
        } 
        
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 8px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        .inventory-container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: relative;
        } 
        
        .inventory-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        } 
        
        .inventory-value { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        } 
        
        .inventory-value h3 { 
            margin: 0; 
            color: var(--dark-color); 
        } 
        
        .inventory-value .value { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--success-color); 
        } 
        
        .inventory-table { 
            width: 100%; 
            border-collapse: collapse; 
        } 
        
        .inventory-table th, .inventory-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        } 
        
        .inventory-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: var(--dark-color); 
        } 
        
        .inventory-table tr:hover { 
            background-color: #f8f9fa; 
        } 
        
        .inventory-table tr.expiring-soon { 
            background-color: #fff8e1; 
        } 
        
        .inventory-table tr.expired { 
            background-color: #ffebee; 
        } 
        
        .stock-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: 500; 
        } 
        
        .stock-high { 
            background-color: #d4edda; 
            color: #155724; 
        } 
        
        .stock-medium { 
            background-color: #fff3cd; 
            color: #856404; 
        } 
        
        .stock-low { 
            background-color: #f8d7da; 
            color: #721c24; 
        } 
        
        .expiry-badge { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: 500; 
        } 
        
        .expiry-good { 
            background-color: #d4edda; 
            color: #155724; 
        } 
        
        .expiry-warning { 
            background-color: #fff3cd; 
            color: #856404; 
        } 
        
        .expiry-expired { 
            background-color: #f8d7da; 
            color: #721c24; 
        } 
        
        .action-buttons { 
            display: flex; 
            gap: 5px; 
        } 
        
        .action-buttons button { 
            padding: 5px 8px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            color: white; 
        } 
        
        .btn-edit { 
            background: var(--secondary-color); 
        } 
        
        .btn-delete { 
            background: var(--accent-color); 
        } 
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        } 
        
        .modal.active { 
            display: flex; 
        } 
        
        .modal-content { 
            background: white; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            position: relative;
        } 
        
        .modal-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        } 
        
        .modal-header h3 { 
            margin: 0; 
            color: var(--dark-color); 
        } 
        
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: var(--gray-color); 
        } 
        
        .modal-body { 
            padding: 20px; 
        } 
        
        .form-group { 
            margin-bottom: 15px; 
        } 
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
        } 
        
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 1rem; 
        } 
        
        .modal-footer { 
            padding: 15px 20px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        } 
        
        .receipt { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            max-width: 400px; 
            margin: 0 auto; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            font-family: 'Courier New', monospace; 
        } 
        
        .receipt-header { 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 1px dashed #ccc; 
            padding-bottom: 10px; 
        } 
        
        .receipt-header h2 { 
            margin-bottom: 5px; 
        } 
        
        .receipt-header p { 
            margin: 2px 0; 
            font-size: 0.9rem; 
        } 
        
        .receipt-items { 
            margin-bottom: 20px; 
        } 
        
        .receipt-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
        } 
        
        .receipt-footer { 
            border-top: 1px dashed #ccc; 
            padding-top: 10px; 
        } 
        
        .receipt-total { 
            display: flex; 
            justify-content: space-between; 
            font-weight: 700; 
            margin-bottom: 5px; 
        } 
        
        .receipt-actions { 
            margin-top: 20px; 
            display: flex; 
            gap: 10px; 
        } 
        
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 20px; 
            border-radius: 4px; 
            color: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            transform: translateX(150%); 
            transition: transform 0.3s ease-out; 
        } 
        
        .notification.show { 
            transform: translateX(0); 
        } 
        
        .notification.success { 
            background: var(--success-color); 
        } 
        
        .notification.error { 
            background: var(--accent-color); 
        } 
        
        .notification.warning { 
            background: var(--warning-color); 
        } 
        
        .notification.info { 
            background: var(--secondary-color); 
        } 
        
        .notification i { 
            margin-right: 10px; 
            font-size: 1.2rem; 
        } 
        
        .empty-state { 
            text-align: center; 
            padding: 40px; 
            color: var(--gray-color); 
        } 
        
        .empty-state i { 
            font-size: 3rem; 
            margin-bottom: 15px; 
            color: #ddd; 
        } 
        
        .empty-state h3 { 
            margin-bottom: 10px; 
        } 
        
        .login-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
        } 
        
        .login-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            width: 400px; 
            padding: 40px; 
        } 
        
        .login-header { 
            text-align: center; 
            margin-bottom: 30px; 
        } 
        
        .login-header h1 { 
            color: var(--primary-color); 
            margin-bottom: 10px; 
        } 
        
        .login-header p { 
            color: var(--gray-color); 
        } 
        
        .login-tabs { 
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #eee; 
        } 
        
        .login-tab { 
            flex: 1; 
            padding: 10px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 500; 
        } 
        
        .login-tab.active { 
            border-bottom: 2px solid var(--secondary-color); 
            color: var(--secondary-color); 
        } 
        
        .tab-content { 
            display: none; 
        } 
        
        .tab-content.active { 
            display: block; 
        } 
        
        .login-btn { 
            width: 100%; 
            padding: 12px; 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.3s; 
            position: relative;
        } 
        
        .login-btn:hover { 
            background: #2980b9; 
        } 
        
        .login-btn.loading {
            color: transparent;
        }
        
        .login-btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .login-error { 
            color: var(--accent-color); 
            margin-top: 15px; 
            text-align: center; 
            display: none; 
        } 
        
        .sales-tracker-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sales-tracker-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .sales-tracker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .sales-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .sales-tracker-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sales-tracker-period {
            font-size: 0.9rem;
            color: #666;
        }
        
        .sales-tracker-content {
            margin-bottom: 15px;
        }
        
        .sales-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .sales-metric-label {
            font-weight: 500;
        }
        
        .sales-metric-value {
            font-weight: 700;
        }
        
        .sales-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--accent-color);
        }
        
        .trend-neutral {
            color: #666;
        }
        
        .sales-tracker-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .view-details-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .view-details-btn:hover {
            color: #2980b9;
        }
        
        .expenses-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .expense-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .expense-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-info {
            flex: 1;
        }
        
        .expense-category {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }
        
        .expense-description {
            font-size: 1rem;
        }
        
        .expense-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .expense-amount {
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .expense-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .analysis-alert {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .analysis-alert-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .analysis-alert-description {
            color: #666;
        }
        
        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .analysis-metric-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .analysis-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .analysis-metric-value.high {
            color: var(--warning-color);
        }
        
        .analysis-metric-value.medium {
            color: var(--secondary-color);
        }
        
        .analysis-metric-value.low {
            color: var(--success-color);
        }
        
        .analysis-metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .analysis-alerts-list {
            margin-top: 20px;
        }
        
        .analysis-alert-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .analysis-alert-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .analysis-alert-item-title {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .analysis-alert-item-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .analysis-alert-item-description {
            color: #666;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .summary-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .top-items-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .top-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .top-items-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .top-items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .top-item-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .top-item-info {
            flex: 1;
            margin-left: 10px;
        }
        
        .top-item-name {
            font-weight: 600;
        }
        
        .top-item-sales {
            font-size: 0.9rem;
            color: #666;
        }
        
        .top-item-value {
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .settings-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .settings-form h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            background-color: var(--success-color);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            display: none;
            z-index: 1000;
        }
        
        .sync-status.show {
            display: block;
        }
        
        .sync-status.syncing {
            background-color: var(--warning-color);
        }
        
        .sync-status.error {
            background-color: var(--accent-color);
        }
        
        .barcode-scanner-container {
            position: relative;
            width: 100%;
            height: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            background-color: #000;
        }
        
        .barcode-scanner-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .barcode-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .barcode-input-group input {
            flex: 1;
        }
        
        .barcode-input-group button {
            white-space: nowrap;
        }
        
        .daily-report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .daily-report-controls label {
            font-weight: 500;
        }
        
        .daily-report-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .daily-report-controls button {
            padding: 8px 15px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .daily-report-controls button:hover {
            background: #2980b9;
        }
        
        .report-section {
            margin-bottom: 30px;
        }
        
        .report-section h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .daily-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .daily-summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .daily-summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        
        .daily-summary-card .label {
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .daily-sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .daily-sales-table th, .daily-sales-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .daily-sales-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .daily-sales-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .daily-sales-table .no-data {
            text-align: center;
            color: var(--gray-color);
        }
        
        .deleted-sales-section {
            margin-top: 30px;
        }
        
        .deleted-sales-section h4 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .deleted-sales-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .deleted-sales-table th, .deleted-sales-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .deleted-sales-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .deleted-sales-table tr:hover {
            background-color: #f8f9fa;
        }
        
        @media (max-width: 992px) { 
            .pos-container { 
                grid-template-columns: 1fr; 
            } 
            .cart-section { 
                order: -1; 
            } 
            .expenses-container {
                grid-template-columns: 1fr;
            }
        } 
        
        @media (max-width: 768px) { 
            .mobile-menu-btn { 
                display: block; 
            } 
            .sidebar { 
                transform: translateX(-100%); 
            } 
            .sidebar.active { 
                transform: translateX(0); 
            } 
            .main-content { 
                margin-left: 0; 
            } 
            .nav-menu { 
                display: flex; 
                overflow-x: auto; 
            } 
            .nav-item { 
                margin-bottom: 0; 
            } 
            .nav-link { 
                padding: 10px; 
                flex-direction: column; 
                align-items: center; 
                font-size: 0.8rem; 
            } 
            .nav-link i { 
                margin-right: 0; 
                margin-bottom: 5px; 
            } 
            .dashboard-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .sales-tracker-container {
                grid-template-columns: 1fr;
            }
            .analysis-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        } 
        
        @media (max-width: 576px) { 
            .products-grid { 
                grid-template-columns: repeat(2, 1fr); 
            } 
            .cart-actions { 
                grid-template-columns: 1fr; 
            } 
            .dashboard-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Pa Gerrys Mart POS</h1>
                <p>Point of Sale Management</p>
            </div>
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">Login</div>
                <div class="login-tab" data-tab="register" id="register-tab" style="display: none;">Register</div>
            </div>
            <form id="login-form" class="tab-content active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" id="login-submit-btn">Login</button>
                <div id="login-error" class="login-error">Invalid email or password. Please try again.</div>
            </form>
            <form id="register-form" class="tab-content">
                <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" placeholder="Enter your full name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" placeholder="Enter your email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" placeholder="Create a password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="register-confirm-password">Confirm Password</label>
                    <input type="password" id="register-confirm-password" placeholder="Confirm your password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="register-role">Role</label>
                    <select id="register-role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="cashier">Cashier</option>
                    </select>
                </div>
                <button type="submit" class="login-btn" id="register-submit-btn">Register</button>
                <div id="register-error" class="login-error">Registration failed. Please try again.</div>
            </form>
        </div>
    </div>
    
    <div id="app-container" class="container" style="display: none;">
        <div id="sidebar" class="sidebar">
            <div class="logo">
                <h1>Pa Gerrys Mart POS</h1>
                <p>Point of Sale</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="pos">
                        <i class="fas fa-cash-register"></i>
                        <span>Point of Sale</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="inventory">
                        <i class="fas fa-boxes"></i>
                        <span>Inventory</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="sales-tracker">
                        <i class="fas fa-chart-line"></i>
                        <span>Sales Tracker</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="sales-reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Sales Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="expenses">
                        <i class="fas fa-receipt"></i>
                        <span>Expenses</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="analysis">
                        <i class="fas fa-chart-pie"></i>
                        <span>Analysis</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item" id="user-management-nav" style="display: none;">
                    <a href="#" class="nav-link" data-page="user-management">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h2 id="page-title">Dashboard</h2>
                <div class="user-info">
                    <div class="user-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="current-user">Store Manager</span>
                    <span id="user-role" class="user-role">Admin</span>
                    <button class="logout-btn" id="logout-btn">Logout</button>
                </div>
            </div>
            
            <div id="dashboard-page" class="page-content">
                <div class="dashboard-summary">
                    <div class="summary-card">
                        <div class="summary-value" id="dashboard-daily-sales">‚Ç¶0.00</div>
                        <div class="summary-label">Today's Sales</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="dashboard-daily-transactions">0</div>
                        <div class="summary-label">Transactions</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="dashboard-daily-expenses">‚Ç¶0.00</div>
                        <div class="summary-label">Today's Expenses</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="dashboard-net-profit">‚Ç¶0.00</div>
                        <div class="summary-label">Net Profit</div>
                    </div>
                </div>
                
                <div class="sales-tracker-container">
                    <div class="sales-tracker-card">
                        <div class="sales-tracker-header">
                            <div class="sales-tracker-title">
                                <i class="fas fa-calendar-day"></i> Today's Sales
                            </div>
                            <div class="sales-tracker-period" id="dashboard-today-date">Today</div>
                        </div>
                        <div class="sales-tracker-content">
                            <div class="sales-metric">
                                <span class="sales-metric-label">Items Sold:</span>
                                <span class="sales-metric-value" id="dashboard-today-items-sold">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Revenue:</span>
                                <span class="sales-metric-value" id="dashboard-today-revenue">‚Ç¶0.00</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Transactions:</span>
                                <span class="sales-metric-value" id="dashboard-today-transactions">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Avg. Transaction:</span>
                                <span class="sales-metric-value" id="dashboard-today-avg-transaction">‚Ç¶0.00</span>
                            </div>
                        </div>
                        <div class="sales-tracker-footer">
                            <span class="sales-trend" id="dashboard-today-trend">
                                <i class="fas fa-minus"></i> No change from yesterday
                            </span>
                        </div>
                    </div>
                    
                    <div class="sales-tracker-card">
                        <div class="sales-tracker-header">
                            <div class="sales-tracker-title">
                                <i class="fas fa-warehouse"></i> Inventory Status
                            </div>
                        </div>
                        <div class="sales-tracker-content">
                            <div class="sales-metric">
                                <span class="sales-metric-label">Total Products:</span>
                                <span class="sales-metric-value" id="dashboard-total-products">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">In Stock:</span>
                                <span class="sales-metric-value" id="dashboard-in-stock">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Low Stock:</span>
                                <span class="sales-metric-value" id="dashboard-low-stock">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Out of Stock:</span>
                                <span class="sales-metric-value" id="dashboard-out-of-stock">0</span>
                            </div>
                        </div>
                        <div class="sales-tracker-footer">
                            <button class="view-details-btn" data-page="inventory">
                                View Details <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="sales-tracker-card">
                        <div class="sales-tracker-header">
                            <div class="sales-tracker-title">
                                <i class="fas fa-chart-pie"></i> Analysis
                            </div>
                        </div>
                        <div class="sales-tracker-content">
                            <div class="sales-metric">
                                <span class="sales-metric-label">High Risk Items:</span>
                                <span class="sales-metric-value" id="dashboard-high-risk-items">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Discrepancies:</span>
                                <span class="sales-metric-value" id="dashboard-unusual-discrepancies">0</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Potential Loss:</span>
                                <span class="sales-metric-value" id="dashboard-potential-loss">‚Ç¶0.00</span>
                            </div>
                            <div class="sales-metric">
                                <span class="sales-metric-label">Last Alert:</span>
                                <span class="sales-metric-value" id="dashboard-last-alert">None</span>
                            </div>
                        </div>
                        <div class="sales-tracker-footer">
                            <button class="view-details-btn" data-page="analysis">
                                View Details <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="top-items-container">
                    <div class="top-items-header">
                        <h3 class="top-items-title">Top Selling Items</h3>
                        <select class="form-select" id="dashboard-top-items-period" style="width: auto;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="top-items-list" id="dashboard-top-items-list">
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <h3>No Sales Data</h3>
                            <p>Start making sales to see your top selling items.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="pos-page" class="page-content" style="display: none;">
                <div class="pos-container">
                    <div class="products-section">
                        <div class="section-header">
                            <h3>Products</h3>
                            <button class="btn btn-primary" id="add-product-btn">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" id="product-search" placeholder="Search products or scan barcode...">
                            <button id="search-btn"><i class="fas fa-search"></i></button>
                        </div>
                        
                        <div class="products-grid" id="products-grid">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No Products Added Yet</h3>
                                <p>Click "Add Product" to start adding your inventory</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cart-section">
                        <h3>Current Sale</h3>
                        
                        <div class="cart-items" id="cart-items">
                            <p style="text-align: center; color: #999; padding: 20px;">No items in cart</p>
                        </div>
                        
                        <div class="cart-summary">
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">‚Ç¶0.00</span>
                            </div>
                        </div>
                        
                        <div class="cart-actions">
                            <button class="btn btn-outline" id="clear-cart-btn">Clear</button>
                            <button class="btn btn-success" id="complete-sale-btn">Complete Sale</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="inventory-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="inventory-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>Inventory Management</h3>
                        <button class="btn btn-primary" id="add-inventory-btn">
                            <i class="fas fa-plus"></i> Add New Product
                        </button>
                    </div>
                    
                    <div class="inventory-value">
                        <h3>Total Inventory Value</h3>
                        <div class="value" id="inventory-total-value">‚Ç¶0.00</div>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="inventory-search" placeholder="Search inventory...">
                        <button id="inventory-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <div class="inventory-table-container">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <tr>
                                    <td colspan="9" style="text-align: center;">No products in inventory</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="sales-tracker-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="sales-tracker-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>Sales Tracker</h3>
                        <div>
                            <button class="btn btn-primary" id="export-sales-btn">
                                <i class="fas fa-download"></i> Export Sales
                            </button>
                        </div>
                    </div>
                    
                    <div class="daily-report-controls">
                        <label for="sales-date-select">Select Date:</label>
                        <input type="date" id="sales-date-select" value="">
                        <button id="filter-sales-by-date-btn">Filter Sales</button>
                    </div>
                    
                    <div class="sales-tracker-container">
                        <div class="sales-tracker-card">
                            <div class="sales-tracker-header">
                                <div class="sales-tracker-title">
                                    <i class="fas fa-calendar-day"></i> Today's Sales
                                </div>
                                <div class="sales-tracker-period" id="sales-today-date">Today</div>
                            </div>
                            <div class="sales-tracker-content">
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Items Sold:</span>
                                    <span class="sales-metric-value" id="sales-today-items-sold">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Revenue:</span>
                                    <span class="sales-metric-value" id="sales-today-revenue">‚Ç¶0.00</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Transactions:</span>
                                    <span class="sales-metric-value" id="sales-today-transactions">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Avg. Transaction:</span>
                                    <span class="sales-metric-value" id="sales-today-avg-transaction">‚Ç¶0.00</span>
                                </div>
                            </div>
                            <div class="sales-tracker-footer">
                                <span class="sales-trend" id="sales-today-trend">
                                    <i class="fas fa-minus"></i> No change from yesterday
                                </span>
                            </div>
                        </div>
                        
                        <div class="sales-tracker-card">
                            <div class="sales-tracker-header">
                                <div class="sales-tracker-title">
                                    <i class="fas fa-calendar-week"></i> This Week
                                </div>
                                <div class="sales-tracker-period" id="sales-week-range">This Week</div>
                            </div>
                            <div class="sales-tracker-content">
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Items Sold:</span>
                                    <span class="sales-metric-value" id="sales-week-items-sold">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Revenue:</span>
                                    <span class="sales-metric-value" id="sales-week-revenue">‚Ç¶0.00</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Transactions:</span>
                                    <span class="sales-metric-value" id="sales-week-transactions">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Avg. Transaction:</span>
                                    <span class="sales-metric-value" id="sales-week-avg-transaction">‚Ç¶0.00</span>
                                </div>
                            </div>
                            <div class="sales-tracker-footer">
                                <span class="sales-trend" id="sales-week-trend">
                                    <i class="fas fa-minus"></i> No change from last week
                                </span>
                            </div>
                        </div>
                        
                        <div class="sales-tracker-card">
                            <div class="sales-tracker-header">
                                <div class="sales-tracker-title">
                                    <i class="fas fa-calendar-alt"></i> This Month
                                </div>
                                <div class="sales-tracker-period" id="sales-month-year">This Month</div>
                            </div>
                            <div class="sales-tracker-content">
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Items Sold:</span>
                                    <span class="sales-metric-value" id="sales-month-items-sold">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Revenue:</span>
                                    <span class="sales-metric-value" id="sales-month-revenue">‚Ç¶0.00</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Transactions:</span>
                                    <span class="sales-metric-value" id="sales-month-transactions">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Avg. Transaction:</span>
                                    <span class="sales-metric-value" id="sales-month-avg-transaction">‚Ç¶0.00</span>
                                </div>
                            </div>
                            <div class="sales-tracker-footer">
                                <span class="sales-trend" id="sales-month-trend">
                                    <i class="fas fa-minus"></i> No change from last month
                                </span>
                            </div>
                        </div>
                        
                        <div class="sales-tracker-card">
                            <div class="sales-tracker-header">
                                <div class="sales-tracker-title">
                                    <i class="fas fa-calendar"></i> This Year
                                </div>
                                <div class="sales-tracker-period" id="sales-current-year">This Year</div>
                            </div>
                            <div class="sales-tracker-content">
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Items Sold:</span>
                                    <span class="sales-metric-value" id="sales-year-items-sold">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Revenue:</span>
                                    <span class="sales-metric-value" id="sales-year-revenue">‚Ç¶0.00</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Transactions:</span>
                                    <span class="sales-metric-value" id="sales-year-transactions">0</span>
                                </div>
                                <div class="sales-metric">
                                    <span class="sales-metric-label">Avg. Transaction:</span>
                                    <span class="sales-metric-value" id="sales-year-avg-transaction">‚Ç¶0.00</span>
                                </div>
                            </div>
                            <div class="sales-tracker-footer">
                                <span class="sales-trend" id="sales-year-trend">
                                    <i class="fas fa-minus"></i> No change from last year
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="top-items-container">
                        <div class="top-items-header">
                            <h3 class="top-items-title">Top Selling Items</h3>
                            <select class="form-select" id="top-items-period" style="width: auto;">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="top-items-list" id="top-items-list">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <h3>No Sales Data</h3>
                                <p>Start making sales to see your top selling items.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="sales-reports-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="sales-reports-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <h3>Sales Reports</h3>
                    
                    <div class="daily-report-controls">
                        <label for="report-date">Select Date:</label>
                        <input type="date" id="report-date" value="">
                        <button id="generate-report-btn">Generate Report</button>
                        <button id="export-report-btn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                    </div>
                    
                    <div class="report-section">
                        <h3><i class="fas fa-chart-bar"></i> Overall Summary</h3>
                        <div class="sales-summary" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-total-sales">‚Ç¶0.00</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Total Sales</div>
                            </div>
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-transactions">0</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Transactions</div>
                            </div>
                            <div class="summary-card" style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                                <div class="value" style="font-size: 1.8rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px;" id="report-items-sold">0</div>
                                <div class="label" style="color: var(--gray-color); font-size: 0.9rem;">Items Sold</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h3><i class="fas fa-calendar-day"></i> Daily Report</h3>
                        <div class="daily-summary" id="daily-summary">
                            <div class="daily-summary-card">
                                <div class="value" id="daily-total-sales">‚Ç¶0.00</div>
                                <div class="label">Daily Sales</div>
                            </div>
                            <div class="daily-summary-card">
                                <div class="value" id="daily-transactions">0</div>
                                <div class="label">Daily Transactions</div>
                            </div>
                            <div class="daily-summary-card">
                                <div class="value" id="daily-items-sold">0</div>
                                <div class="label">Daily Items Sold</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">Daily Sales Details</h4>
                        <table class="daily-sales-table">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Time</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="daily-sales-table-body">
                                <tr>
                                    <td colspan="5" class="no-data">No sales data for selected date</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="report-section">
                        <h3><i class="fas fa-history"></i> Recent Sales</h3>
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center;">No sales data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="expenses-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="expenses-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>Expenses Tracker</h3>
                        <div>
                            <button class="btn btn-primary" id="export-expenses-btn">
                                <i class="fas fa-download"></i> Export Expenses
                            </button>
                        </div>
                    </div>
                    
                    <div class="expenses-container">
                        <div class="expense-form">
                            <h3>Add New Expense</h3>
                            <div class="form-group">
                                <label for="expense-category">Category</label>
                                <select class="form-select" id="expense-category" required>
                                    <option value="">Select Category</option>
                                    <option value="utilities">Utilities</option>
                                    <option value="rent">Rent</option>
                                    <option value="salaries">Salaries</option>
                                    <option value="supplies">Supplies</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expense-description">Description</label>
                                <input type="text" class="form-input" id="expense-description" placeholder="Enter expense description" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-amount">Amount (‚Ç¶)</label>
                                <input type="number" class="form-input" id="expense-amount" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-date">Date</label>
                                <input type="date" class="form-input" id="expense-date" required>
                            </div>
                            <button type="button" class="btn btn-primary" id="add-expense-btn">Add Expense</button>
                        </div>
                        
                        <div class="expense-list">
                            <h3>Recent Expenses</h3>
                            <div id="expenses-list-container">
                                <div class="empty-state">
                                    <i class="fas fa-receipt"></i>
                                    <h3>No Expenses Recorded</h3>
                                    <p>Start by adding expenses to track your business costs.</p>
                                </div>
                            </div>
                            <div class="expense-total">
                                <span>Total Expenses:</span>
                                <span id="total-expenses">‚Ç¶0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="analysis-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="analysis-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>Inventory Analysis</h3>
                        <button class="btn btn-danger" id="clear-analysis-data-btn">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                    
                    <div class="analysis-alert">
                        <div class="analysis-alert-title">
                            <i class="fas fa-info-circle"></i> Analysis Alert
                        </div>
                        <div class="analysis-alert-description">
                            Unusual inventory discrepancy detected for "Premium Rice". Expected stock: 50, Actual stock: 35. Potential loss: ‚Ç¶3,000.
                        </div>
                    </div>
                    
                    <div class="analysis-metrics">
                        <div class="analysis-metric-card">
                            <div class="analysis-metric-value high">5</div>
                            <div class="analysis-metric-label">High Risk Items</div>
                        </div>
                        <div class="analysis-metric-card">
                            <div class="analysis-metric-value medium">12</div>
                            <div class="analysis-metric-label">Discrepancies</div>
                        </div>
                        <div class="analysis-metric-card">
                            <div class="analysis-metric-value high">‚Ç¶8,500</div>
                            <div class="analysis-metric-label">Potential Loss (This Month)</div>
                        </div>
                        <div class="analysis-metric-card">
                            <div class="analysis-metric-value low">3</div>
                            <div class="analysis-metric-label">Resolved Issues</div>
                        </div>
                    </div>
                    
                    <div class="settings-form">
                        <h3>Analysis Settings</h3>
                        <div class="form-group">
                            <label for="discrepancy-threshold">Discrepancy Threshold (%)</label>
                            <input type="number" class="form-input" id="discrepancy-threshold" value="10" min="1" max="100">
                            <small>Alert when actual stock is below this percentage of expected stock</small>
                        </div>
                        <div class="form-group">
                            <label for="high-value-threshold">High Value Threshold (‚Ç¶)</label>
                            <input type="number" class="form-input" id="high-value-threshold" value="5000" min="0" step="100">
                            <small>Mark items above this value as high risk</small>
                        </div>
                        <div class="form-group">
                            <label for="enable-notifications">
                                <input type="checkbox" id="enable-notifications" checked> Enable Analysis Alerts
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary" id="save-analysis-settings-btn">Save Settings</button>
                    </div>
                    
                    <div class="inventory-container">
                        <div class="inventory-header">
                            <h3>Recent Analysis Alerts</h3>
                        </div>
                        <div class="analysis-alerts-list" id="analysis-alerts-list">
                            <div class="empty-state">
                                <i class="fas fa-chart-pie"></i>
                                <h3>No Recent Alerts</h3>
                                <p>Analysis system is monitoring your inventory.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="settings-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="settings-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>System Settings</h3>
                    </div>
                    
                    <div class="settings-form">
                        <h3>Store Information</h3>
                        <div class="form-group">
                            <label for="store-name">Store Name</label>
                            <input type="text" class="form-input" id="store-name" placeholder="Enter store name">
                        </div>
                        <div class="form-group">
                            <label for="store-address">Store Address</label>
                            <input type="text" class="form-input" id="store-address" placeholder="Enter store address">
                        </div>
                        <div class="form-group">
                            <label for="store-phone">Store Phone</label>
                            <input type="tel" class="form-input" id="store-phone" placeholder="Enter store phone">
                        </div>
                        <div class="form-group">
                            <label for="store-email">Store Email</label>
                            <input type="email" class="form-input" id="store-email" placeholder="Enter store email">
                        </div>
                        <button type="button" class="btn btn-primary" id="save-store-settings-btn">Save Store Settings</button>
                    </div>
                    
                    <div class="settings-form">
                        <h3>System Preferences</h3>
                        <div class="form-group">
                            <label for="currency">Currency Symbol</label>
                            <select class="form-select" id="currency">
                                <option value="‚Ç¶">‚Ç¶ (Naira)</option>
                                <option value="$">$ (Dollar)</option>
                                <option value="¬£">¬£ (Pound)</option>
                                <option value="‚Ç¨">‚Ç¨ (Euro)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="low-stock-threshold">Low Stock Threshold</label>
                            <input type="number" class="form-input" id="low-stock-threshold" value="10" min="1">
                            <small>Alert when stock falls below this number</small>
                        </div>
                        <div class="form-group">
                            <label for="expiry-warning-days">Expiry Warning Days</label>
                            <input type="number" class="form-input" id="expiry-warning-days" value="30" min="1">
                            <small>Warn when product expires within this many days</small>
                        </div>
                        <div class="form-group">
                            <label for="enable-auto-backup">
                                <input type="checkbox" id="enable-auto-backup" checked> Enable Automatic Backup
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary" id="save-system-settings-btn">Save System Settings</button>
                    </div>
                    
                    <div class="settings-form">
                        <h3>Data Management</h3>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="export-all-data-btn">
                                <i class="fas fa-download"></i> Export All Data
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-outline" id="import-data-btn">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-danger" id="clear-all-data-btn">
                                <i class="fas fa-trash"></i> Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="user-management-page" class="page-content" style="display: none;">
                <div class="inventory-container">
                    <div class="loading-overlay" id="user-management-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="inventory-header">
                        <h3>User Management</h3>
                        <button class="btn btn-primary" id="add-user-btn">
                            <i class="fas fa-plus"></i> Add New User
                        </button>
                    </div>
                    
                    <div class="inventory-table-container">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center;">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <div class="loading-overlay" id="product-modal-loading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h3 id="modal-title">Add New Product</h3>
                <button class="modal-close" id="close-add-product-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="product-name">Product Name</label>
                    <input type="text" class="form-input" id="product-name" placeholder="Enter product name" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Price</label>
                    <input type="number" class="form-input" id="product-price" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="product-stock">Stock Quantity</label>
                    <input type="number" class="form-input" id="product-stock" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label for="product-expiry">Expiry Date</label>
                    <input type="date" class="form-input" id="product-expiry">
                </div>
                <div class="form-group">
                    <label for="product-category">Category</label>
                    <select class="form-select" id="product-category" required>
                        <option value="">Select Category</option>
                        <option value="food">Food</option>
                        <option value="beverages">Beverages</option>
                        <option value="household">Household</option>
                        <option value="personal-care">Personal Care</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Barcode (Optional)</label>
                    <div class="barcode-input-group">
                        <input type="text" class="form-input" id="product-barcode" placeholder="Enter barcode or scan">
                        <button type="button" class="btn btn-outline" id="scan-barcode-btn">
                            <i class="fas fa-barcode"></i> Scan
                        </button>
                    </div>
                    <div id="barcode-scanner-container" class="barcode-scanner-container" style="display: none;">
                    </div>
                    <div class="barcode-scanner-controls" id="barcode-scanner-controls" style="display: none;">
                        <button type="button" class="btn btn-danger" id="stop-scanner-btn">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-add-product">Cancel</button>
                <button class="btn btn-primary" id="save-product">Add Product</button>
            </div>
        </div>
    </div>
    
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Complete Sale</h3>
                <button class="modal-close" id="close-checkout-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="checkout-summary">
                </div>
                <div class="form-group">
                    <label for="payment-method">Payment Method</label>
                    <select class="form-select" id="payment-method">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="transfer">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customer-name">Customer Name (Optional)</label>
                    <input type="text" class="form-input" id="customer-name" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label for="customer-phone">Customer Phone (Optional)</label>
                    <input type="tel" class="form-input" id="customer-phone" placeholder="Enter customer phone">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-checkout">Cancel</button>
                <button class="btn btn-primary" id="complete-checkout">Complete Sale</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">Operation completed successfully!</span>
    </div>

    <button id="mobile-menu-btn" class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>
    
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash"></i> You're offline. Changes will sync when connection is restored.
    </div>
    
    <div id="sync-status" class="sync-status">
        <i class="fas fa-sync"></i> <span id="sync-status-text">Syncing data...</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNs0xDtFR97iFgDQlxn8ueLxFJA4L60Gc",
            authDomain: "point-of-sale-2cc64.firebaseapp.com",
            databaseURL: "https://point-of-sale-2cc64-default-rtdb.firebaseio.com/",
            projectId: "point-of-sale-2cc64",
            storageBucket: "point-of-sale-2cc64.firebasestorage.app",
            messagingSenderId: "365581311369",
            appId: "1:365581311369:web:688fb59bffae277a6ed558",
            measurementId: "G-VGS89T5DSF"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        try {
            db.enablePersistence({ synchronizeTabs: true });
        } catch (err) {
            if (err.code === 'failed-precondition') {
                console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code === 'unimplemented') {
                console.warn('The current browser does not support persistence.');
            }
        }

        let inventory = [];
        let cart = [];
        let sales = [];
        let salesData = {
            today: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
            week: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
            month: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
            year: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
            topItems: {}
        };
        let expenses = [];
        let analysisAlerts = [];
        let currentPage = 'dashboard';
        let currentFilter = 'all';
        let currentUser = null;
        let settings = {
            storeName: "Pa Gerrys Mart POS",
            storeAddress: "",
            storePhone: "",
            storeEmail: "",
            currency: "‚Ç¶",
            lowStockThreshold: 10,
            expiryWarningDays: 30,
            discrepancyThreshold: 10,
            highValueThreshold: 5000,
            enableNotifications: true,
            enableAutoBackup: true
        };

        const STORAGE_KEYS = {
            INVENTORY: 'pos_inventory',
            SALES: 'pos_sales',
            SALES_DATA: 'pos_sales_data',
            EXPENSES: 'pos_expenses',
            ANALYSIS_ALERTS: 'pos_analysis_alerts',
            SETTINGS: 'pos_settings',
            CURRENT_USER: 'pos_current_user'
        };

        const offlineIndicator = document.getElementById('offline-indicator');
        const syncStatus = document.getElementById('sync-status');
        const syncStatusText = document.getElementById('sync-status-text');
        let isOnline = navigator.onLine;
        let syncQueue = [];
        let connectionRetryCount = 0;
        const MAX_RETRY_ATTEMPTS = 3;
        const RETRY_DELAY = 5000;

        function checkFirebaseConnection() {
            if (!isOnline) return;
            
            db.collection('connection_test').limit(1).get()
                .then(() => {
                    connectionRetryCount = 0;
                    if (syncQueue.length > 0) {
                        processSyncQueue();
                    }
                })
                .catch(error => {
                    if (connectionRetryCount < MAX_RETRY_ATTEMPTS) {
                        connectionRetryCount++;
                        setTimeout(checkFirebaseConnection, RETRY_DELAY);
                    } else {
                        showNotification('Connection to database failed. Some features may be limited.', 'warning');
                    }
                });
        }

        function cleanupDuplicateSales() {
            const receiptNumbers = new Set();
            const uniqueSales = [];
            
            sales.forEach(sale => {
                if (!receiptNumbers.has(sale.receiptNumber)) {
                    receiptNumbers.add(sale.receiptNumber);
                    uniqueSales.push(sale);
                }
            });
            
            if (sales.length !== uniqueSales.length) {
                sales = uniqueSales;
                saveToLocalStorage();
            }
        }

        function setupRealtimeListeners() {
            if (isOnline) {
                db.collection('products').onSnapshot((snapshot) => {
                    const fetchedProducts = [];
                    snapshot.forEach((doc) => {
                        fetchedProducts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Create a map of existing products by ID for efficient lookup
                    const productMap = new Map();
                    inventory.forEach(product => {
                        if (!product.deleted) {
                            productMap.set(product.id, product);
                        }
                    });
                    
                    // Process fetched products
                    fetchedProducts.forEach(product => {
                        if (!product.deleted) {
                            const existingProduct = productMap.get(product.id);
                            
                            if (existingProduct) {
                                // Compare timestamps to determine which is newer
                                const localLastUpdated = existingProduct.lastUpdated ? new Date(existingProduct.lastUpdated) : new Date(0);
                                const fetchedLastUpdated = product.lastUpdated ? new Date(product.lastUpdated) : new Date(0);
                                
                                // Use the newer version
                                if (fetchedLastUpdated > localLastUpdated) {
                                    productMap.set(product.id, product);
                                }
                            } else {
                                // New product, add to map
                                productMap.set(product.id, product);
                            }
                        }
                    });
                    
                    // Convert map back to array
                    const mergedProducts = Array.from(productMap.values());
                    
                    // Update inventory if there are changes
                    if (JSON.stringify(inventory) !== JSON.stringify(mergedProducts)) {
                        inventory = mergedProducts;
                        saveToLocalStorage();
                        loadProducts();
                        if (currentPage === 'inventory') {
                            updateInventoryTable();
                        }
                    }
                });
                
                db.collection('sales').orderBy('date', 'desc').onSnapshot((snapshot) => {
                    const fetchedSales = [];
                    snapshot.forEach((doc) => {
                        fetchedSales.push({ id: doc.id, ...doc.data() });
                    });
                    
                    sales = fetchedSales;
                    saveToLocalStorage();
                    
                    if (currentPage === 'sales-reports') {
                        updateSalesReports();
                    }
                    
                    updateDashboard();
                });
                
                db.collection('salesData').doc('salesData').onSnapshot((doc) => {
                    if (doc.exists) {
                        const fetchedSalesData = doc.data();
                        
                        if (JSON.stringify(salesData) !== JSON.stringify(fetchedSalesData)) {
                            salesData = fetchedSalesData;
                            saveToLocalStorage();
                            updateSalesTracker();
                            updateDashboard();
                        }
                    }
                });
                
                db.collection('expenses').onSnapshot((snapshot) => {
                    const fetchedExpenses = [];
                    snapshot.forEach((doc) => {
                        fetchedExpenses.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (JSON.stringify(expenses) !== JSON.stringify(fetchedExpenses)) {
                        expenses = fetchedExpenses;
                        saveToLocalStorage();
                        updateExpensesList();
                        updateDashboard();
                    }
                });
                
                db.collection('analysisAlerts').onSnapshot((snapshot) => {
                    const fetchedAnalysisAlerts = [];
                    snapshot.forEach((doc) => {
                        fetchedAnalysisAlerts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (JSON.stringify(analysisAlerts) !== JSON.stringify(fetchedAnalysisAlerts)) {
                        analysisAlerts = fetchedAnalysisAlerts;
                        saveToLocalStorage();
                        updateAnalysisAlerts();
                        updateDashboard();
                    }
                });
                
                db.collection('settings').doc('settings').onSnapshot((doc) => {
                    if (doc.exists) {
                        const fetchedSettings = doc.data();
                        
                        if (JSON.stringify(settings) !== JSON.stringify(fetchedSettings)) {
                            settings = fetchedSettings;
                            saveToLocalStorage();
                            updateDashboard();
                        }
                    }
                });
            }
        }

        function addToSyncQueue(operation) {
            if (operation.type === 'saveSale') {
                const receiptNumber = operation.data.receiptNumber;
                
                if (syncQueue.some(op => 
                    op.type === 'saveSale' && 
                    op.data.receiptNumber === receiptNumber
                )) {
                    return;
                }
                
                if (isOnline) {
                    db.collection('sales').where('receiptNumber', '==', receiptNumber).get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                const index = syncQueue.findIndex(op => 
                                    op.type === 'saveSale' && 
                                    op.data.receiptNumber === receiptNumber
                                );
                                if (index !== -1) {
                                    syncQueue.splice(index, 1);
                                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error checking for existing sale:', error);
                        });
                }
            } else {
                if (syncQueue.some(op => 
                    op.type === operation.type && 
                    JSON.stringify(op.data) === JSON.stringify(operation.data)
                )) {
                    return;
                }
            }

            syncQueue.push(operation);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));

            if (isOnline) {
                processSyncQueue();
            } else {
                showNotification('Offline: Sale saved locally and will sync automatically.', 'info');
            }
        }

        function processSyncQueue() {
            if (syncQueue.length === 0) return;

            syncStatus.classList.add('show', 'syncing');
            syncStatusText.textContent = 'Syncing data...';

            const operation = syncQueue.shift();

            if (operation.synced) {
                processNext();
                return;
            }

            let operationPromise;

            if (operation.type === 'saveSale') {
                operationPromise = db.collection('sales').where('receiptNumber', '==', operation.data.receiptNumber).get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            return db.collection('sales').add(operation.data)
                                .then(docRef => {
                                    const localSaleIndex = sales.findIndex(s => s.receiptNumber === operation.data.receiptNumber);
                                    if (localSaleIndex !== -1) {
                                        sales[localSaleIndex].id = docRef.id;
                                        saveToLocalStorage();
                                    }
                                    return docRef;
                                });
                        } else {
                            const firebaseSale = snapshot.docs[0];
                            const localSaleIndex = sales.findIndex(s => s.receiptNumber === operation.data.receiptNumber);
                            if (localSaleIndex !== -1) {
                                sales[localSaleIndex].id = firebaseSale.id;
                                saveToLocalStorage();
                            }
                            return Promise.resolve();
                        }
                    });
            } else if (operation.type === 'saveProduct') {
                if (operation.data.id && !operation.data.id.startsWith('temp_')) {
                    operationPromise = db.collection('products').doc(operation.data.id).set(operation.data)
                        .then(() => {
                            const localProductIndex = inventory.findIndex(p => p.id === operation.data.id);
                            if (localProductIndex !== -1) {
                                inventory[localProductIndex].lastUpdated = new Date();
                                saveToLocalStorage();
                            }
                        });
                } else {
                    operationPromise = db.collection('products').add(operation.data)
                        .then(docRef => {
                            const localProductIndex = inventory.findIndex(p => p.id === operation.data.id);
                            if (localProductIndex !== -1) {
                                inventory[localProductIndex].id = docRef.id;
                                saveToLocalStorage();
                            }
                            return docRef;
                        });
                }
            } else if (operation.type === 'saveSalesData') {
                operationPromise = db.collection('salesData').doc('salesData').set(operation.data);
            } else if (operation.type === 'saveExpenses') {
                operationPromise = db.collection('expenses').doc(operation.data.id).set(operation.data);
            } else if (operation.type === 'saveAnalysisAlerts') {
                operationPromise = db.collection('analysisAlerts').doc(operation.data.id).set(operation.data);
            } else if (operation.type === 'saveSettings') {
                operationPromise = db.collection('settings').doc('settings').set(operation.data);
            } else {
                operationPromise = Promise.resolve();
            }

            operationPromise
                .then(() => {
                    operation.synced = true;
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    processNext();
                })
                .catch(error => {
                    syncQueue.unshift(operation);
                    localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
                    syncStatus.classList.remove('syncing');
                    syncStatus.classList.add('error');
                    syncStatusText.textContent = 'Sync error';
                    setTimeout(() => syncStatus.classList.remove('show', 'error'), 3000);
                });

            function processNext() {
                setTimeout(() => {
                    if (syncQueue.length > 0) {
                        processSyncQueue();
                    } else {
                        syncStatus.classList.remove('syncing');
                        syncStatus.classList.add('show');
                        syncStatusText.textContent = 'All data synced';
                        setTimeout(() => syncStatus.classList.remove('show'), 3000);
                    }
                }, 800);
            }
        }

        function loadSyncQueue() {
            const savedQueue = localStorage.getItem('syncQueue');
            if (savedQueue) {
                try {
                    syncQueue = JSON.parse(savedQueue);
                } catch (e) {
                    syncQueue = [];
                }
            }
        }

        function cleanupSyncQueue() {
            syncQueue = syncQueue.filter(op => !op.synced);
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
        }

        function loadFromLocalStorage() {
            try {
                const savedInventory = localStorage.getItem(STORAGE_KEYS.INVENTORY);
                if (savedInventory) inventory = JSON.parse(savedInventory);

                const savedSales = localStorage.getItem(STORAGE_KEYS.SALES);
                if (savedSales) sales = JSON.parse(savedSales);

                const savedSalesData = localStorage.getItem(STORAGE_KEYS.SALES_DATA);
                if (savedSalesData) salesData = JSON.parse(savedSalesData);

                const savedExpenses = localStorage.getItem(STORAGE_KEYS.EXPENSES);
                if (savedExpenses) expenses = JSON.parse(savedExpenses);

                const savedAnalysisAlerts = localStorage.getItem(STORAGE_KEYS.ANALYSIS_ALERTS);
                if (savedAnalysisAlerts) analysisAlerts = JSON.parse(savedAnalysisAlerts);

                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedSettings) settings = JSON.parse(savedSettings);

                const savedCurrentUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
                if (savedCurrentUser) currentUser = JSON.parse(savedCurrentUser);
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.INVENTORY, JSON.stringify(inventory));
                localStorage.setItem(STORAGE_KEYS.SALES, JSON.stringify(sales));
                localStorage.setItem(STORAGE_KEYS.SALES_DATA, JSON.stringify(salesData));
                localStorage.setItem(STORAGE_KEYS.EXPENSES, JSON.stringify(expenses));
                localStorage.setItem(STORAGE_KEYS.ANALYSIS_ALERTS, JSON.stringify(analysisAlerts));
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                }
            } catch (e) {
                console.error('Error saving data to localStorage:', e);
            }
        }

        function saveDataToFirestore(collection, docId, data) {
            data.timestamp = firebase.firestore.FieldValue.serverTimestamp();
            data.userId = currentUser ? currentUser.uid : 'offline_user';
            
            saveToLocalStorage();
            
            if (collection === 'products') {
                if (!docId) {
                    docId = 'temp_' + Date.now();
                    data.id = docId;
                    data.isOffline = true;
                    data.lastUpdated = new Date().toISOString();
                    inventory.push(data);
                } else {
                    const index = inventory.findIndex(item => item.id === docId);
                    if (index !== -1) {
                        inventory[index] = { ...inventory[index], ...data, lastUpdated: new Date().toISOString() };
                    }
                }
                loadProducts();
                updateDashboard();
            } else if (collection === 'salesData') {
                const section = docId;
                if (section && salesData[section]) {
                    salesData[section] = { ...salesData[section], ...data };
                    updateSalesTracker();
                    updateDashboard();
                }
            } else if (collection === 'expenses') {
                const index = expenses.findIndex(expense => expense.id === docId);
                if (index !== -1) {
                    expenses[index] = { ...expenses[index], ...data };
                }
                updateExpensesList();
                updateDashboard();
            } else if (collection === 'analysisAlerts') {
                const index = analysisAlerts.findIndex(alert => alert.id === docId);
                if (index !== -1) {
                    analysisAlerts[index] = { ...analysisAlerts[index], ...data };
                }
                updateAnalysisAlerts();
                updateDashboard();
            } else if (collection === 'settings') {
                settings = { ...settings, ...data };
                updateDashboard();
            }
            
            if (isOnline) {
                if (docId && !docId.startsWith('temp_')) {
                    return db.collection(collection).doc(docId).set(data);
                } else {
                    return db.collection(collection).add(data).then(docRef => {
                        if (collection === 'products') {
                            const index = inventory.findIndex(item => item.id === docId);
                            if (index !== -1) {
                                inventory[index].id = docRef.id;
                                inventory[index].isOffline = false;
                            }
                        }
                        return docRef;
                    });
                }
            } else {
                addToSyncQueue({
                    type: 'save' + collection.charAt(0).toUpperCase() + collection.slice(1),
                    data: data
                });
                return Promise.resolve({ id: docId });
            }
        }

        function checkOnlineStatus() {
            isOnline = navigator.onLine;
            if (isOnline) {
                offlineIndicator.classList.remove('show');
                if (syncQueue.length > 0) {
                    processSyncQueue();
                }
            } else {
                offlineIndicator.classList.add('show');
            }
        }

        const AuthModule = {
            async signUp(email, password, name, role = 'cashier') {
                try {
                    const adminUser = firebase.auth().currentUser;
                    if (!adminUser) {
                        showNotification("You must be logged in as an admin to create users.", "error");
                        return { success: false };
                    }

                    const adminEmail = adminUser.email;
                    const adminPassword = prompt("Please confirm your admin password to continue:");

                    await firebase.auth().signOut();

                    const newUserCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const newUser = newUserCredential.user;

                    await newUser.updateProfile({ displayName: name });

                    await db.collection("users").doc(newUser.uid).set({
                        uid: newUser.uid,
                        name,
                        email,
                        role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: adminUser.uid
                    });

                    await firebase.auth().signOut();

                    await firebase.auth().signInWithEmailAndPassword(adminEmail, adminPassword);

                    showNotification(`‚úÖ User "${name}" (${role}) created successfully!`, "success");
                    return { success: true };
                } catch (error) {
                    showNotification("‚ùå Error creating user: " + error.message, "error");
                    return { success: false, error: error.message };
                }
            },

            async signIn(email, password) {
                const loginSubmitBtn = document.getElementById('login-submit-btn');
                loginSubmitBtn.classList.add('loading');
                loginSubmitBtn.disabled = true;
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    
                    currentUser = {
                        uid: user.uid,
                        ...userData
                    };
                    
                    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                    showApp();
                    showNotification('Login successful!', 'success');
                    return { success: true };
                } catch (error) {
                    showNotification(error.message, 'error');
                    return { success: false, error: error.message };
                } finally {
                    loginSubmitBtn.classList.remove('loading');
                    loginSubmitBtn.disabled = false;
                }
            },
            
            async signOut() {
                try {
                    await auth.signOut();
                    currentUser = null;
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    showLogin();
                    showNotification('Logged out successfully', 'info');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            },
            
            isAdmin() {
                return currentUser && currentUser.role === 'admin';
            },
            
            onAuthStateChanged(callback) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        const userData = userDoc.data();
                        
                        if (userData) {
                            currentUser = {
                                uid: user.uid,
                                ...userData
                            };
                            localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                            callback(currentUser);
                        }
                    } else {
                        currentUser = null;
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                        callback(null);
                    }
                });
            }
        };

        function showLogin() {
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('register-tab').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name;
                document.getElementById('user-role').textContent = currentUser.role;
                
                if (currentUser.role === 'admin') {
                    document.getElementById('user-management-nav').style.display = 'block';
                    document.getElementById('register-tab').style.display = 'block';
                } else {
                    document.getElementById('user-management-nav').style.display = 'none';
                    document.getElementById('register-tab').style.display = 'none';
                }
            }
            
            try {
                setupRealtimeListeners();
                loadProducts();
                updateDashboard();
                updateSalesTracker();
                updateExpensesList();
                updateAnalysisAlerts();
            } catch (error) {
                showNotification('Error loading data. Using offline cache.', 'warning');
                loadProducts();
                updateDashboard();
                updateSalesTracker();
                updateExpensesList();
                updateAnalysisAlerts();
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            notificationMessage.textContent = message;
            notification.className = `notification ${type} show`;
            
            const icon = notification.querySelector('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-exclamation-circle' : 
                           type === 'warning' ? 'fas fa-exclamation-triangle' : 
                           'fas fa-info-circle';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', { 
                style: 'currency', 
                currency: 'NGN',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        function formatDate(date) {
            if (!date) return '-';
            
            let d;
            
            if (date && typeof date.toDate === 'function') {
                d = date.toDate();
            } 
            else if (date instanceof Date) {
                d = date;
            }
            else if (typeof date === 'string') {
                d = new Date(date);
            }
            else if (typeof date === 'number') {
                d = new Date(date);
            }
            else {
                return '-';
            }
            
            if (isNaN(d.getTime())) {
                return '-';
            }
            
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function generateReceiptNumber() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `R${year}${month}${day}${random}`;
        }
        
        function switchSection(section) {
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (section === 'user-management') {
                showUserManagement();
            } else {
                document.getElementById(`${section}-page`).style.display = 'block';
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`.nav-link[data-page="${section}"]`).classList.add('active');
                
                currentPage = section;
                
                if (section === 'dashboard') {
                    updateDashboard();
                } else if (section === 'sales-tracker') {
                    updateSalesTracker();
                } else if (section === 'sales-reports') {
                    updateSalesReports();
                } else if (section === 'expenses') {
                    updateExpensesList();
                } else if (section === 'analysis') {
                    updateAnalysisAlerts();
                } else if (section === 'settings') {
                    loadSettings();
                } else if (section === 'inventory') {
                    updateInventoryTable();
                }
            }
        }
        function removeDuplicateProducts() {
    const uniqueProducts = [];
    const seenIds = new Set();
    
    for (const product of inventory) {
        if (!seenIds.has(product.id)) {
            seenIds.add(product.id);
            uniqueProducts.push(product);
        }
    }
    
    inventory = uniqueProducts;
}

// Helper function to remove duplicate products
function removeDuplicateProducts() {
    const uniqueProducts = [];
    const seenIds = new Set();
    
    for (const product of inventory) {
        if (!seenIds.has(product.id)) {
            seenIds.add(product.id);
            uniqueProducts.push(product);
        }
    }
    
    inventory = uniqueProducts;
}

// Updated loadProducts function
function loadProducts(filteredInventory = null) {
    // Remove duplicates first
    removeDuplicateProducts();
    
    const productsGrid = document.getElementById('products-grid');
    productsGrid.innerHTML = ''; // ‚úÖ Always clear grid before re-render

    // Use filtered inventory if provided, otherwise use full inventory
    const productsToDisplay = filteredInventory || inventory;

    if (!productsToDisplay || productsToDisplay.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>No Products Added Yet</h3>
                <p>Click "Add Product" to start adding your inventory</p>
            </div>`;
        return;
    }

    productsToDisplay.forEach(item => {
        if (item.deleted) return;

        const productCard = document.createElement('div');
        productCard.className = 'product-card';

        const today = new Date();
        const expiryDate = new Date(item.expiryDate);
        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

        let expiryWarning = '';
        if (daysUntilExpiry < 0) {
            expiryWarning = `<div class="expiry-warning"><i class="fas fa-exclamation-triangle"></i> Expired</div>`;
        } else if (daysUntilExpiry <= settings.expiryWarningDays) {
            expiryWarning = `<div class="expiry-warning"><i class="fas fa-clock"></i> Expires in ${daysUntilExpiry} days</div>`;
        }

        let stockClass = 'stock-high';
        if (item.stock <= 0) {
            stockClass = 'stock-low';
        } else if (item.stock <= settings.lowStockThreshold) {
            stockClass = 'stock-medium';
        }

        productCard.innerHTML = `
            <div class="product-img"><i class="fas fa-box"></i></div>
            <h4>${item.name}</h4>
            <div class="price">${formatCurrency(item.price)}</div>
            <div class="stock ${stockClass}">Stock: ${item.stock}</div>
            ${expiryWarning}
        `;

        productCard.addEventListener('click', () => addToCart(item));
        productsGrid.appendChild(productCard);
    });
}

// Updated updateInventoryTable function
function updateInventoryTable(filteredInventory = null) {
    const inventoryTableBody = document.getElementById('inventory-table-body');
    inventoryTableBody.innerHTML = ''; // ‚úÖ Clear before re-render

    // Use filtered inventory if provided, otherwise use full inventory
    const productsToDisplay = filteredInventory || inventory;

    if (!productsToDisplay || productsToDisplay.length === 0) {
        inventoryTableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center;">No products in inventory</td>
            </tr>`;
        document.getElementById('inventory-total-value').textContent = formatCurrency(0);
        return;
    }

    productsToDisplay.forEach(item => {
        if (item.deleted) return;

        const row = document.createElement('tr');
        const status = getProductStatus(item);
        let statusClass = '';
        let statusText = '';

        switch (status) {
            case 'in-stock': statusClass = 'stock-high'; statusText = 'In Stock'; break;
            case 'low-stock': statusClass = 'stock-medium'; statusText = 'Low Stock'; break;
            case 'out-of-stock': statusClass = 'stock-low'; statusText = 'Out of Stock'; break;
            case 'expired': statusClass = 'expiry-expired'; statusText = 'Expired'; break;
            case 'expiring-soon': statusClass = 'expiry-warning'; statusText = 'Expiring Soon'; break;
        }

        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${formatCurrency(item.price)}</td>
            <td>${item.stock}</td>
            <td>${formatDate(new Date(item.expiryDate))}</td>
            <td><span class="stock-badge ${statusClass}">${statusText}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-edit" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;

        inventoryTableBody.appendChild(row);
    });

    // Add event listeners to all edit and delete buttons
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            editProduct(this.getAttribute('data-id'));
        });
    });
    
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', function() {
            deleteProduct(this.getAttribute('data-id'));
        });
    });

    const totalValue = productsToDisplay.reduce((total, item) => total + (item.price * item.stock), 0);
    document.getElementById('inventory-total-value').textContent = formatCurrency(totalValue);
}

// Updated search function
function searchProducts(query) {
    if (!query || query.trim() === '') {
        loadProducts();
        updateInventoryTable();
        return;
    }
    
    const filteredInventory = inventory.filter(item => {
        if (item.deleted) return false;
        
        const searchTerm = query.toLowerCase();
        return (
            item.name.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm) ||
            item.id.toLowerCase().includes(searchTerm)
        );
    });
    
    loadProducts(filteredInventory);
    updateInventoryTable(filteredInventory);
}

// Debounce function to improve search performance
function debounce(func, delay) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

// Initialize search event listener (add this to your initialization code)
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function(e) {
            searchProducts(e.target.value);
        }, 300));
    }
});


        
        function updateSalesTracker() {
            const today = new Date();
            document.getElementById('sales-today-date').textContent = formatDate(today);
            
            const weekRange = getWeekRange(today);
            document.getElementById('sales-week-range').textContent = weekRange;
            
            const monthYear = getMonthYear(today);
            document.getElementById('sales-month-year').textContent = monthYear;
            
            document.getElementById('sales-current-year').textContent = today.getFullYear();
            
            document.getElementById('sales-today-items-sold').textContent = salesData.today.itemsSold;
            document.getElementById('sales-today-revenue').textContent = formatCurrency(salesData.today.revenue);
            document.getElementById('sales-today-transactions').textContent = salesData.today.transactions;
            document.getElementById('sales-today-avg-transaction').textContent = formatCurrency(salesData.today.avgTransaction);
            
            document.getElementById('sales-week-items-sold').textContent = salesData.week.itemsSold;
            document.getElementById('sales-week-revenue').textContent = formatCurrency(salesData.week.revenue);
            document.getElementById('sales-week-transactions').textContent = salesData.week.transactions;
            document.getElementById('sales-week-avg-transaction').textContent = formatCurrency(salesData.week.avgTransaction);
            
            document.getElementById('sales-month-items-sold').textContent = salesData.month.itemsSold;
            document.getElementById('sales-month-revenue').textContent = formatCurrency(salesData.month.revenue);
            document.getElementById('sales-month-transactions').textContent = salesData.month.transactions;
            document.getElementById('sales-month-avg-transaction').textContent = formatCurrency(salesData.month.avgTransaction);
            
            document.getElementById('sales-year-items-sold').textContent = salesData.year.itemsSold;
            document.getElementById('sales-year-revenue').textContent = formatCurrency(salesData.year.revenue);
            document.getElementById('sales-year-transactions').textContent = salesData.year.transactions;
            document.getElementById('sales-year-avg-transaction').textContent = formatCurrency(salesData.year.avgTransaction);
            
            document.getElementById('sales-today-trend').innerHTML = '<i class="fas fa-minus"></i> No change from yesterday';
            document.getElementById('sales-week-trend').innerHTML = '<i class="fas fa-minus"></i> No change from last week';
            document.getElementById('sales-month-trend').innerHTML = '<i class="fas fa-minus"></i> No change from last month';
            document.getElementById('sales-year-trend').innerHTML = '<i class="fas fa-minus"></i> No change from last year';
            
            updateTopItems('today');
        }
        
        function updateTopItems(period, page = 'sales-tracker') {
            const listId = page === 'dashboard' ? 'dashboard-top-items-list' : 'top-items-list';
            const topItemsList = document.getElementById(listId);
            const topItems = salesData.topItems[period] || [];
            
            if (topItems.length === 0) {
                topItemsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <h3>No Sales Data</h3>
                        <p>Start making sales to see your top selling items.</p>
                    </div>
                `;
                return;
            }
            
            topItemsList.innerHTML = '';
            
            topItems.slice(0, 5).forEach((item, index) => {
                const topItemElement = document.createElement('div');
                topItemElement.className = 'top-item';
                
                topItemElement.innerHTML = `
                    <div class="top-item-rank">${index + 1}</div>
                    <div class="top-item-info">
                        <div class="top-item-name">${item.name}</div>
                        <div class="top-item-sales">${item.quantity} sold</div>
                    </div>
                    <div class="top-item-value">${formatCurrency(item.total)}</div>
                `;
                
                topItemsList.appendChild(topItemElement);
            });
        }
        
        function updateExpensesList() {
            const expensesListContainer = document.getElementById('expenses-list-container');
            const totalExpensesElement = document.getElementById('total-expenses');
            
            if (expenses.length === 0) {
                expensesListContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>No Expenses Recorded</h3>
                        <p>Start by adding expenses to track your business costs.</p>
                    </div>
                `;
                totalExpensesElement.textContent = formatCurrency(0);
                return;
            }
            
            expensesListContainer.innerHTML = '';
            let totalExpenses = 0;
            
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.slice(0, 10).forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                
                totalExpenses += expense.amount;
                
                expenseItem.innerHTML = `
                    <div class="expense-info">
                        <div class="expense-category">${expense.category}</div>
                        <div class="expense-description">${expense.description}</div>
                        <div class="expense-date">${formatDate(new Date(expense.date))}</div>
                    </div>
                    <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                `;
                
                expensesListContainer.appendChild(expenseItem);
            });
            
            totalExpensesElement.textContent = formatCurrency(totalExpenses);
        }
        
        function updateAnalysisAlerts() {
            const analysisAlertsList = document.getElementById('analysis-alerts-list');
            
            if (analysisAlerts.length === 0) {
                analysisAlertsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <h3>No Recent Alerts</h3>
                        <p>Analysis system is monitoring your inventory.</p>
                    </div>
                `;
                return;
            }
            
            analysisAlertsList.innerHTML = '';
            
            const sortedAlerts = [...analysisAlerts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAlerts.slice(0, 5).forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'analysis-alert-item';
                
                alertItem.innerHTML = `
                    <div class="analysis-alert-item-header">
                        <div class="analysis-alert-item-title">${alert.title}</div>
                        <div class="analysis-alert-item-date">${formatDate(new Date(alert.date))}</div>
                    </div>
                    <div class="analysis-alert-item-description">${alert.description}</div>
                `;
                
                analysisAlertsList.appendChild(alertItem);
            });
        }
        
        async function updateSalesReports() {
            document.getElementById('sales-reports-loading').style.display = 'flex';
            
            try {
                const snapshot = await db.collection('sales').orderBy('date', 'desc').get();
                const firebaseSales = [];
                snapshot.forEach(doc => {
                    firebaseSales.push({ id: doc.id, ...doc.data() });
                });
                
                sales = firebaseSales;
                saveToLocalStorage();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-date').value = today;
                
                generateReport();
                
            } catch (error) {
                showNotification('Error loading sales data', 'error');
            } finally {
                document.getElementById('sales-reports-loading').style.display = 'none';
            }
        }
        
        function generateReport() {
            const selectedDate = document.getElementById('report-date').value;
            
            if (!selectedDate) {
                showNotification('Please select a date', 'error');
                return;
            }
            
            document.getElementById('sales-reports-loading').style.display = 'flex';
            
            const filteredSales = sales.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate === selectedDate;
            });
            
            let totalSales = 0;
            let totalTransactions = filteredSales.length;
            let totalItemsSold = 0;
            
            filteredSales.forEach(sale => {
                totalSales += sale.total;
                sale.items.forEach(item => {
                    totalItemsSold += item.quantity;
                });
            });
            
            document.getElementById('report-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('report-transactions').textContent = totalTransactions;
            document.getElementById('report-items-sold').textContent = totalItemsSold;
            
            document.getElementById('daily-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('daily-transactions').textContent = totalTransactions;
            document.getElementById('daily-items-sold').textContent = totalItemsSold;
            
            const dailySalesTableBody = document.getElementById('daily-sales-table-body');
            dailySalesTableBody.innerHTML = '';
            
            if (filteredSales.length === 0) {
                dailySalesTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">No sales data for selected date</td>
                    </tr>
                `;
            } else {
                filteredSales.forEach(sale => {
                    const row = document.createElement('tr');
                    
                    const itemsText = sale.items.map(item => 
                        `${item.name} (${item.quantity})`
                    ).join(', ');
                    
                    row.innerHTML = `
                        <td>${sale.receiptNumber}</td>
                        <td>${formatDate(new Date(sale.date)).split(' ')[1]}</td>
                        <td>${itemsText}</td>
                        <td>${formatCurrency(sale.total)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSaleDetails('${sale.receiptNumber}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    `;
                    
                    dailySalesTableBody.appendChild(row);
                });
            }
            
            const salesTableBody = document.getElementById('sales-table-body');
            salesTableBody.innerHTML = '';
            
            const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sortedSales.length === 0) {
                salesTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center;">No sales data available</td>
                    </tr>
                `;
            } else {
                sortedSales.slice(0, 10).forEach(sale => {
                    const row = document.createElement('tr');
                    
                    const itemsText = sale.items.map(item => 
                        `${item.name} (${item.quantity})`
                    ).join(', ');
                    
                    row.innerHTML = `
                        <td>${sale.receiptNumber}</td>
                        <td>${formatDate(new Date(sale.date)).split(' ')[0]}</td>
                        <td>${itemsText}</td>
                        <td>${formatCurrency(sale.total)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSaleDetails('${sale.receiptNumber}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    `;
                    
                    salesTableBody.appendChild(row);
                });
            }
            
            document.getElementById('sales-reports-loading').style.display = 'none';
        }
        
        function viewSaleDetails(receiptNumber) {
            const sale = sales.find(s => s.receiptNumber === receiptNumber);
            
            if (!sale) {
                showNotification('Sale not found', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            
            const itemsList = sale.items.map(item => 
                `<tr>
                    <td>${item.name}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.total)}</td>
                </tr>`
            ).join('');
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Sale Details</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Receipt Number:</label>
                            <p>${sale.receiptNumber}</p>
                        </div>
                        <div class="form-group">
                            <label>Date:</label>
                            <p>${formatDate(new Date(sale.date))}</p>
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <p>${sale.paymentMethod}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer:</label>
                            <p>${sale.customerName || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Items:</label>
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsList}
                                </tbody>
                            </table>
                        </div>
                        <div class="form-group">
                            <label>Total:</label>
                            <p style="font-weight: bold; font-size: 1.2rem;">${formatCurrency(sale.total)}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline modal-close">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        function exportSalesReport() {
            const selectedDate = document.getElementById('report-date').value;
            
            if (!selectedDate) {
                showNotification('Please select a date first', 'error');
                return;
            }
            
            const filteredSales = sales.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate === selectedDate;
            });
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Receipt Number,Date,Time,Items,Total,Payment Method,Customer\n";
            
            filteredSales.forEach(sale => {
                const itemsText = sale.items.map(item => 
                    `${item.name}(${item.quantity})`
                ).join(';');
                
                const saleDate = new Date(sale.date);
                const dateStr = saleDate.toLocaleDateString();
                const timeStr = saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                csvContent += `${sale.receiptNumber},${dateStr},${timeStr},"${itemsText}",${sale.total},${sale.paymentMethod},"${sale.customerName || ''}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sales_report_${selectedDate}.csv`);
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
            
            showNotification('Sales report exported successfully', 'success');
        }
        
        function loadSettings() {
            document.getElementById('store-name').value = settings.storeName || '';
            document.getElementById('store-address').value = settings.storeAddress || '';
            document.getElementById('store-phone').value = settings.storePhone || '';
            document.getElementById('store-email').value = settings.storeEmail || '';
            document.getElementById('currency').value = settings.currency || '‚Ç¶';
            document.getElementById('low-stock-threshold').value = settings.lowStockThreshold || 10;
            document.getElementById('expiry-warning-days').value = settings.expiryWarningDays || 30;
            document.getElementById('discrepancy-threshold').value = settings.discrepancyThreshold || 10;
            document.getElementById('high-value-threshold').value = settings.highValueThreshold || 5000;
            document.getElementById('enable-notifications').checked = settings.enableNotifications !== false;
            document.getElementById('enable-auto-backup').checked = settings.enableAutoBackup !== false;
        }
        
        function saveStoreSettings() {
            settings.storeName = document.getElementById('store-name').value;
            settings.storeAddress = document.getElementById('store-address').value;
            settings.storePhone = document.getElementById('store-phone').value;
            settings.storeEmail = document.getElementById('store-email').value;
            
            saveToLocalStorage();
            showNotification('Store settings saved successfully', 'success');
            
            saveDataToFirestore('settings', 'settings', settings);
        }
        
        function saveSystemSettings() {
            settings.currency = document.getElementById('currency').value;
            settings.lowStockThreshold = parseInt(document.getElementById('low-stock-threshold').value);
            settings.expiryWarningDays = parseInt(document.getElementById('expiry-warning-days').value);
            settings.enableAutoBackup = document.getElementById('enable-auto-backup').checked;
            
            saveToLocalStorage();
            showNotification('System settings saved successfully', 'success');
            
            saveDataToFirestore('settings', 'settings', settings);
        }
        
        function saveAnalysisSettings() {
            settings.discrepancyThreshold = parseInt(document.getElementById('discrepancy-threshold').value);
            settings.highValueThreshold = parseInt(document.getElementById('high-value-threshold').value);
            settings.enableNotifications = document.getElementById('enable-notifications').checked;
            
            saveToLocalStorage();
            showNotification('Analysis settings saved successfully', 'success');
            
            saveDataToFirestore('settings', 'settings', settings);
        }
        
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            let dailySales = 0;
            let dailyTransactions = 0;
            let dailyExpenses = 0;
            
            dailySales = salesData.today.revenue;
            dailyTransactions = salesData.today.transactions;
            
            expenses.forEach(expense => {
                if (expense.date === today) {
                    dailyExpenses += expense.amount;
                }
            });
            
            const netProfit = dailySales - dailyExpenses;
            
            document.getElementById('dashboard-daily-sales').textContent = formatCurrency(dailySales);
            document.getElementById('dashboard-daily-transactions').textContent = dailyTransactions;
            document.getElementById('dashboard-daily-expenses').textContent = formatCurrency(dailyExpenses);
            document.getElementById('dashboard-net-profit').textContent = formatCurrency(netProfit);
            
            document.getElementById('dashboard-today-date').textContent = formatDate(new Date());
            document.getElementById('dashboard-today-items-sold').textContent = salesData.today.itemsSold;
            document.getElementById('dashboard-today-revenue').textContent = formatCurrency(salesData.today.revenue);
            document.getElementById('dashboard-today-transactions').textContent = salesData.today.transactions;
            document.getElementById('dashboard-today-avg-transaction').textContent = formatCurrency(salesData.today.avgTransaction);
            
            let inStock = 0;
            let lowStock = 0;
            let outOfStock = 0;
            
            inventory.forEach(item => {
                const status = getProductStatus(item);
                if (status === 'in-stock') {
                    inStock++;
                } else if (status === 'low-stock') {
                    lowStock++;
                } else if (status === 'out-of-stock') {
                    outOfStock++;
                }
            });
            
            document.getElementById('dashboard-total-products').textContent = inventory.length;
            document.getElementById('dashboard-in-stock').textContent = inStock;
            document.getElementById('dashboard-low-stock').textContent = lowStock;
            document.getElementById('dashboard-out-of-stock').textContent = outOfStock;
            
            const totalInventoryValue = inventory.reduce((total, item) => total + (item.price * item.stock), 0);
            document.getElementById('inventory-total-value').textContent = formatCurrency(totalInventoryValue);
            
            const highRiskItems = inventory.filter(item => item.price > settings.highValueThreshold && item.stock < settings.lowStockThreshold).length;
            const unusualDiscrepancies = analysisAlerts.filter(alert => alert.status === 'active').length;
            const potentialLoss = analysisAlerts.reduce((total, alert) => total + (alert.potentialLoss || 0), 0);
            const lastAlert = analysisAlerts.length > 0 ? formatDate(new Date(analysisAlerts[0].date)) : 'None';
            
            document.getElementById('dashboard-high-risk-items').textContent = highRiskItems;
            document.getElementById('dashboard-unusual-discrepancies').textContent = unusualDiscrepancies;
            document.getElementById('dashboard-potential-loss').textContent = formatCurrency(potentialLoss);
            document.getElementById('dashboard-last-alert').textContent = lastAlert;
            
            updateTopItems('today', 'dashboard');
        }
        
        function searchProducts(searchTerm) {
            const productsGrid = document.getElementById('products-grid');
            
            if (searchTerm.trim() === '') {
                loadProducts();
                return;
            }
            
            const filteredProducts = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (item.barcode && item.barcode.includes(searchTerm))
            );
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No Products Found</h3>
                        <p>Try a different search term or add new products to your inventory.</p>
                    </div>
                `;
                return;
            }
            
            productsGrid.innerHTML = '';
            
            filteredProducts.forEach(item => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const today = new Date();
                const expiryDate = new Date(item.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let expiryWarning = '';
                if (daysUntilExpiry < 0) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-exclamation-triangle"></i> Expired</div>`;
                } else if (daysUntilExpiry <= settings.expiryWarningDays) {
                    expiryWarning = `<div class="expiry-warning"><i class="fas fa-clock"></i> Expires in ${daysUntilExpiry} days</div>`;
                }
                
                let stockClass = 'stock-high';
                if (item.stock <= 0) {
                    stockClass = 'stock-low';
                } else if (item.stock <= settings.lowStockThreshold) {
                    stockClass = 'stock-medium';
                }
                
                productCard.innerHTML = `
                    <div class="product-img">
                        <i class="fas fa-box"></i>
                    </div>
                    <h4>${item.name}</h4>
                    <div class="price">${formatCurrency(item.price)}</div>
                    <div class="stock ${stockClass}">Stock: ${item.stock}</div>
                    ${expiryWarning}
                `;
                
                productCard.addEventListener('click', function() {
                    addToCart(item);
                });
                
                productsGrid.appendChild(productCard);
            });
        }
        
        function filterInventory(searchTerm) {
            const inventoryTableBody = document.getElementById('inventory-table-body');
            
            if (searchTerm.trim() === '') {
                updateInventoryTable();
                return;
            }
            
            const filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (item.barcode && item.barcode.includes(searchTerm))
            );
            
            if (filteredInventory.length === 0) {
                inventoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center;">No products found</td>
                    </tr>
                `;
                return;
            }
            
            inventoryTableBody.innerHTML = '';
            
            filteredInventory.forEach(item => {
                const row = document.createElement('tr');
                const status = getProductStatus(item);
                let statusClass = '';
                let statusText = '';
                
                if (status === 'in-stock') {
                    statusClass = 'stock-high';
                    statusText = 'In Stock';
                } else if (status === 'low-stock') {
                    statusClass = 'stock-medium';
                    statusText = 'Low Stock';
                } else if (status === 'out-of-stock') {
                    statusClass = 'stock-low';
                    statusText = 'Out of Stock';
                } else if (status === 'expired') {
                    statusClass = 'expiry-expired';
                    statusText = 'Expired';
                } else if (status === 'expiring-soon') {
                    statusClass = 'expiry-warning';
                    statusText = 'Expiring Soon';
                }
                
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.stock}</td>
                    <td>${formatDate(new Date(item.expiryDate))}</td>
                    <td>
                        <span class="stock-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editProduct(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteProduct(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                inventoryTableBody.appendChild(row);
            });
        }
        
        function addToCart(product) {
            if (product.stock <= 0) {
                showNotification(`${product.name} is out of stock`, 'error');
                return;
            }
            
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showNotification(`Cannot add more ${product.name}. Only ${product.stock} in stock.`, 'warning');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCart();
            showNotification(`${product.name} added to cart`, 'success');
        }
        
        function updateCart() {
            const cartItems = document.getElementById('cart-items');
            const totalElement = document.getElementById('total');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No items in cart</p>';
                totalElement.textContent = formatCurrency(0);
                document.getElementById('complete-sale-btn').disabled = true;
                return;
            }
            
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatCurrency(item.price)}</div>
                        <div class="cart-item-qty">
                            <button class="decrement-qty" data-id="${item.id}">-</button>
                            <span>${item.quantity}</span>
                            <button class="increment-qty" data-id="${item.id}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-total">${formatCurrency(itemTotal)}</div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            // Add event listeners to the new buttons
            document.querySelectorAll('.increment-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    incrementQuantity(productId);
                });
            });
            
            document.querySelectorAll('.decrement-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    decrementQuantity(productId);
                });
            });
            
            totalElement.textContent = formatCurrency(total);
            document.getElementById('complete-sale-btn').disabled = false;
        }
        
        function incrementQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            const product = inventory.find(product => product.id === productId);
            
            if (item && product && item.quantity < product.stock) {
                item.quantity += 1;
                updateCart();
            } else if (item && product) {
                showNotification(`Cannot add more ${item.name}. Only ${product.stock} in stock.`, 'warning');
            }
        }
        
        function decrementQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            
            if (item && item.quantity > 1) {
                item.quantity -= 1;
                updateCart();
            } else if (item && item.quantity === 1) {
                // Remove item from cart if quantity would become 0
                cart = cart.filter(cartItem => cartItem.id !== productId);
                updateCart();
            }
        }
        
        function clearCart() {
            cart = [];
            updateCart();
        }
        
        function showCheckoutModal() {
            const checkoutSummary = document.getElementById('checkout-summary');
            let subtotal = 0;
            
            checkoutSummary.innerHTML = '<table class="inventory-table"><thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead><tbody>';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                checkoutSummary.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(itemTotal)}</td>
                    </tr>
                `;
            });
            
            checkoutSummary.innerHTML += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="font-weight: bold;">Total</td>
                        <td style="font-weight: bold;">${formatCurrency(subtotal)}</td>
                    </tr>
                </tfoot>
                </table>
            `;
            
            document.getElementById('payment-method').value = 'cash';
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            
            document.getElementById('checkout-modal').classList.add('active');
        }
        
        async function completeSale() {
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            const completeCheckoutBtn = document.getElementById('complete-checkout');
            completeCheckoutBtn.classList.add('loading');
            completeCheckoutBtn.disabled = true;
            
            try {
                const paymentMethod = document.getElementById('payment-method').value;
                const customerName = document.getElementById('customer-name').value;
                const customerPhone = document.getElementById('customer-phone').value;
                
                let subtotal = 0;
                const saleItems = [];
                
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    saleItems.push({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        total: itemTotal
                    });
                });
                
                const saleDate = new Date();
                const sale = {
                    receiptNumber: generateReceiptNumber(),
                    clientSaleId: 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    items: saleItems,
                    subtotal: subtotal,
                    total: subtotal,
                    paymentMethod: paymentMethod,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    date: saleDate.toISOString(),
                    createdAt: saleDate,
                    cashier: currentUser.name,
                    cashierId: currentUser.uid
                };
                
                let saleSaved = false;
                if (isOnline) {
                    try {
                        const docRef = await db.collection('sales').add(sale);
                        sale.id = docRef.id;
                        saleSaved = true;
                    } catch (error) {
                        showNotification('Error saving sale to cloud', 'error');
                    }
                } else {
                    addToSyncQueue({
                        type: 'saveSale',
                        data: sale
                    });
                    saleSaved = true;
                }
                
                if (saleSaved) {
                    const stockUpdatePromises = [];
                    for (const cartItem of cart) {
                        const product = inventory.find(p => p.id === cartItem.id);
                        if (product) {
                            product.stock -= cartItem.quantity;
                            checkForAnalysisAlert(product);
                            stockUpdatePromises.push(
                                saveDataToFirestore('products', product.id, product)
                                    .catch(error => console.error('Error updating product stock:', error))
                            );
                        }
                    }
                    
                    await Promise.allSettled(stockUpdatePromises);
                    
                    updateSalesData(sale);
                    showReceipt(sale);
                    
                    cart = [];
                    updateCart();
                    loadProducts();
                    updateDashboard();
                    updateSalesTracker();
                    
                    document.getElementById('checkout-modal').classList.remove('active');
                    
                    saveToLocalStorage();
                    saveDataToFirestore('salesData', 'salesData', salesData);
                    
                    showNotification('Sale completed successfully', 'success');
                } else {
                    showNotification('Failed to complete sale', 'error');
                }
            } catch (error) {
                showNotification('Error completing sale: ' + error.message, 'error');
            } finally {
                completeCheckoutBtn.classList.remove('loading');
                completeCheckoutBtn.disabled = false;
            }
        }
        
        function showReceipt(sale) {
            let receiptModal = document.getElementById('receipt-modal');
            if (!receiptModal) {
                receiptModal = document.createElement('div');
                receiptModal.id = 'receipt-modal';
                receiptModal.className = 'modal';
                receiptModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Sale Receipt</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="receipt-content"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeReceiptModal()">Close</button>
                            <button class="btn btn-primary" onclick="printReceipt()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(receiptModal);
                
                receiptModal.querySelector('.modal-close').addEventListener('click', closeReceiptModal);
            }
            
            const saleDate = sale.date instanceof Date ? sale.date : new Date(sale.date);
            
            let itemsHtml = '';
            sale.items.forEach(item => {
                itemsHtml += `
                    <div class="receipt-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>${formatCurrency(item.total)}</span>
                    </div>
                `;
            });
            
            const receiptContent = document.getElementById('receipt-content');
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h2>${settings.storeName}</h2>
                    <p>${settings.storeAddress}</p>
                    <p>${settings.storePhone}</p>
                </div>
                <div class="receipt-items">
                    ${itemsHtml}
                </div>
                <div class="receipt-footer">
                    <div class="receipt-total">
                        <span>Total:</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Receipt #:</span>
                        <span>${sale.receiptNumber}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Date:</span>
                        <span>${formatDate(saleDate)}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Cashier:</span>
                        <span>${sale.cashier}</span>
                    </div>
                    <div class="receipt-item">
                        <span>Payment:</span>
                        <span>${sale.paymentMethod}</span>
                    </div>
                    ${sale.customerName ? `
                        <div class="receipt-item">
                            <span>Customer:</span>
                            <span>${sale.customerName}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            receiptModal.style.display = 'flex';
        }
        
        function closeReceiptModal() {
            const receiptModal = document.getElementById('receipt-modal');
            if (receiptModal) {
                receiptModal.style.display = 'none';
            }
        }
        
        function printReceipt() {
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Receipt - ${settings.storeName}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                padding: 20px; 
                                max-width: 400px;
                                margin: 0 auto;
                            }
                            .receipt-header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                            }
                            .receipt-items { 
                                margin-bottom: 20px; 
                            }
                            .receipt-item { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                            }
                            .receipt-footer { 
                                border-top: 1px dashed #ccc; 
                                padding-top: 10px; 
                            }
                            .receipt-total { 
                                display: flex; 
                                justify-content: space-between; 
                                font-weight: 700; 
                                margin-bottom: 5px; 
                            }
                            @media print {
                                body { padding: 10px; }
                            }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        function updateSalesData(sale) {
            salesData.today.itemsSold += sale.items.reduce((total, item) => total + item.quantity, 0);
            salesData.today.revenue += sale.total;
            salesData.today.transactions += 1;
            salesData.today.avgTransaction = salesData.today.revenue / salesData.today.transactions;
            
            salesData.week.itemsSold += sale.items.reduce((total, item) => total + item.quantity, 0);
            salesData.week.revenue += sale.total;
            salesData.week.transactions += 1;
            salesData.week.avgTransaction = salesData.week.revenue / salesData.week.transactions;
            
            salesData.month.itemsSold += sale.items.reduce((total, item) => total + item.quantity, 0);
            salesData.month.revenue += sale.total;
            salesData.month.transactions += 1;
            salesData.month.avgTransaction = salesData.month.revenue / salesData.month.transactions;
            
            salesData.year.itemsSold += sale.items.reduce((total, item) => total + item.quantity, 0);
            salesData.year.revenue += sale.total;
            salesData.year.transactions += 1;
            salesData.year.avgTransaction = salesData.year.revenue / salesData.year.transactions;
            
            ['today', 'week', 'month', 'year'].forEach(period => {
                if (!salesData.topItems[period]) {
                    salesData.topItems[period] = [];
                }
                
                sale.items.forEach(item => {
                    const existingItemIndex = salesData.topItems[period].findIndex(topItem => topItem.id === item.id);
                    
                    if (existingItemIndex >= 0) {
                        salesData.topItems[period][existingItemIndex].quantity += item.quantity;
                        salesData.topItems[period][existingItemIndex].total += item.total;
                    } else {
                        salesData.topItems[period].push({
                            id: item.id,
                            name: item.name,
                            quantity: item.quantity,
                            total: item.total
                        });
                    }
                });
                
                salesData.topItems[period].sort((a, b) => b.total - a.total);
            });
            
            saveDataToFirestore('salesData', 'salesData', salesData);
        }
        
        function addProduct() {
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const expiryDate = document.getElementById('product-expiry').value;
            const category = document.getElementById('product-category').value;
            const barcode = document.getElementById('product-barcode').value;
            
            if (!name || !price || !stock || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const newProduct = {
                id: Date.now(),
                name: name,
                price: price,
                stock: stock,
                expiryDate: expiryDate,
                category: category,
                barcode: barcode,
                lastUpdated: new Date().toISOString()
            };
            
            inventory.push(newProduct);
            saveToLocalStorage();
            loadProducts();
            updateDashboard();
            
            document.getElementById('add-product-modal').classList.remove('active');
            document.getElementById('add-product-form').reset();
            
            showNotification(`${name} added successfully`, 'success');
            
            saveDataToFirestore('products', newProduct.id, newProduct);
        }
        
        function editProduct(productId) {
            const product = inventory.find(item => item.id === productId);
            
            if (product) {
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-expiry').value = product.expiryDate;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-barcode').value = product.barcode || '';
                
                document.getElementById('save-product').textContent = 'Update Product';
                document.getElementById('save-product').onclick = function() {
                    updateProduct(productId);
                };
                
                document.getElementById('add-product-modal').classList.add('active');
            }
        }
        
        function updateProduct(productId) {
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const expiryDate = document.getElementById('product-expiry').value;
            const category = document.getElementById('product-category').value;
            const barcode = document.getElementById('product-barcode').value;
            
            if (!name || !price || !stock || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const productIndex = inventory.findIndex(item => item.id === productId);
            
            if (productIndex !== -1) {
                const updatedProduct = {
                    id: productId,
                    name: name,
                    price: price,
                    stock: stock,
                    expiryDate: expiryDate,
                    category: category,
                    barcode: barcode,
                    lastUpdated: new Date().toISOString()
                };
                
                inventory[productIndex] = updatedProduct;
                
                saveToLocalStorage();
                loadProducts();
                updateDashboard();
                
                document.getElementById('add-product-modal').classList.remove('active');
                
                document.getElementById('add-product-form').reset();
                document.getElementById('save-product').textContent = 'Add Product';
                document.getElementById('save-product').onclick = addProduct;
                
                showNotification(`${name} updated successfully`, 'success');
                
                saveDataToFirestore('products', productId, updatedProduct);
            }
        }
        
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                inventory = inventory.filter(item => item.id !== productId);
                saveToLocalStorage();
                loadProducts();
                updateDashboard();
                showNotification('Product deleted successfully', 'success');
                
                saveDataToFirestore('products', 'products', inventory);
            }
        }
        
        function addExpense() {
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            
            if (!category || !description || !amount || !date) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            const newExpense = {
                id: Date.now(),
                category: category,
                description: description,
                amount: amount,
                date: date
            };
            
            expenses.push(newExpense);
            saveToLocalStorage();
            updateExpensesList();
            updateDashboard();
            
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').valueAsDate = new Date();
            
            showNotification('Expense added successfully', 'success');
            
            saveDataToFirestore('expenses', newExpense.id, newExpense);
        }
        
        function exportSalesData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Item Name,Quantity,Price,Total\n";
            
            const today = new Date().toISOString().split('T')[0];
            
            if (salesData.topItems.today) {
                salesData.topItems.today.forEach(item => {
                    csvContent += `${today},${item.name},${item.quantity},${(item.total / item.quantity).toFixed(2)},${item.total.toFixed(2)}\n`;
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sales_data_${today}.csv`);
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
            
            showNotification('Sales data exported successfully', 'success');
        }
        
        function exportExpensesData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Category,Description,Amount\n";
            
            expenses.forEach(expense => {
                csvContent += `${expense.date},${expense.category},${expense.description},${expense.amount.toFixed(2)}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.href = encodedUri;
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `expenses_${today}.csv`);
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
            
            showNotification('Expenses data exported successfully', 'success');
        }
        
        function exportAllData() {
            const allData = {
                inventory: inventory,
                sales: sales,
                salesData: salesData,
                expenses: expenses,
                analysisAlerts: analysisAlerts,
                settings: settings
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement("a");
            link.href = url;
            link.download = `pos_data_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('All data exported successfully', 'success');
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.inventory && Array.isArray(data.inventory)) {
                            inventory = data.inventory;
                        }
                        
                        if (data.sales && Array.isArray(data.sales)) {
                            sales = data.sales;
                        }
                        
                        if (data.salesData && typeof data.salesData === 'object') {
                            salesData = data.salesData;
                        }
                        
                        if (data.expenses && Array.isArray(data.expenses)) {
                            expenses = data.expenses;
                        }
                        
                        if (data.analysisAlerts && Array.isArray(data.analysisAlerts)) {
                            analysisAlerts = data.analysisAlerts;
                        }
                        
                        if (data.settings && typeof data.settings === 'object') {
                            settings = data.settings;
                        }
                        
                        saveToLocalStorage();
                        loadProducts();
                        updateDashboard();
                        updateSalesTracker();
                        updateExpensesList();
                        updateAnalysisAlerts();
                        loadSettings();
                        
                        showNotification('Data imported successfully', 'success');
                    } catch (error) {
                        showNotification('Error importing data. Please check the file format.', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                inventory = [];
                sales = [];
                salesData = {
                    today: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
                    week: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
                    month: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
                    year: { itemsSold: 0, revenue: 0, transactions: 0, avgTransaction: 0 },
                    topItems: {}
                };
                expenses = [];
                analysisAlerts = [];
                
                saveToLocalStorage();
                loadProducts();
                updateDashboard();
                updateSalesTracker();
                updateExpensesList();
                updateAnalysisAlerts();
                loadSettings();
                
                showNotification('All data cleared successfully', 'success');
            }
        }
        
        function clearAnalysisData() {
            if (confirm('Are you sure you want to clear all analysis data? This action cannot be undone.')) {
                analysisAlerts = [];
                saveToLocalStorage();
                updateAnalysisAlerts();
                updateDashboard();
                showNotification('Analysis data cleared successfully', 'success');
                
                saveDataToFirestore('analysisAlerts', 'analysisAlerts', analysisAlerts);
            }
        }
        
        function getProductStatus(item) {
            if (!item.expiryDate) {
                return item.stock > settings.lowStockThreshold ? 'in-stock' : (item.stock > 0 ? 'low-stock' : 'out-of-stock');
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(item.expiryDate);
            
            if (expiry < today) {
                return 'expired';
            } else if (item.stock === 0) {
                return 'out-of-stock';
            } else {
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= settings.expiryWarningDays) {
                    return 'expiring-soon';
                } else if (item.stock < settings.lowStockThreshold) {
                    return 'low-stock';
                } else {
                    return 'in-stock';
                }
            }
        }
        
        function getWeekRange(date) {
            const startDate = new Date(date);
            startDate.setDate(date.getDate() - date.getDay());
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }
        
        function getMonthYear(date) {
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        
        function showUserManagement() {
            const userManagementPage = document.getElementById('user-management-page');
            
            if (!userManagementPage) {
                const mainContent = document.querySelector('.main-content');
                const userManagementHTML = `
                    <div id="user-management-page" class="page-content" style="display: none;">
                        <div class="inventory-container">
                            <div class="loading-overlay" id="user-management-loading" style="display: none;">
                                <div class="loading-spinner"></div>
                            </div>
                            <div class="inventory-header">
                                <h3>User Management</h3>
                                <button class="btn btn-primary" id="add-user-btn">
                                    <i class="fas fa-plus"></i> Add New User
                                </button>
                            </div>
                            
                            <div class="inventory-table-container">
                                <table class="inventory-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="5" style="text-align: center;">Loading users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                mainContent.insertAdjacentHTML('beforeend', userManagementHTML);
                
                document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
                
                loadUsers();
            }
            
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById('user-management-page').style.display = 'block';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('.nav-link[data-page="user-management"]').classList.add('active');
            
            currentPage = 'user-management';
            
            loadUsers();
        }
        
        async function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            
            if (!usersTableBody) return;
            
            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                if (users.length === 0) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center;">No users found</td>
                        </tr>
                    `;
                    return;
                }
                
                usersTableBody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${formatDate(user.lastLogin)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
            } catch (error) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center;">Error loading users</td>
                    </tr>
                `;
            }
        }
        
        function showAddUserModal() {
            document.querySelector('[data-tab="register"]').click();
            showLogin();
        }
        
        function checkForAnalysisAlert(product) {
            if (product.stock < 5 && product.price > 1000) {
                const alert = {
                    id: Date.now(),
                    title: 'Low Stock Alert',
                    description: `${product.name} is running low on stock. Current stock: ${product.stock}. This item has a high value and may be at risk.`,
                    potentialLoss: product.price * 5,
                    date: new Date().toISOString(),
                    status: 'active'
                };
                
                analysisAlerts.unshift(alert);
                
                if (analysisAlerts.length > 10) {
                    analysisAlerts = analysisAlerts.slice(0, 10);
                }
                
                showNotification(`Analysis alert: ${product.name} is running low on stock`, 'warning');
                
                saveDataToFirestore('analysisAlerts', alert.id, alert);
            }
        }
        
        function filterSalesByDate(selectedDate) {
            document.getElementById('sales-tracker-loading').style.display = 'flex';
            
            const filteredSales = sales.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate === selectedDate;
            });
            
            let itemsSold = 0;
            let revenue = 0;
            let transactions = filteredSales.length;
            
            filteredSales.forEach(sale => {
                revenue += sale.total;
                sale.items.forEach(item => {
                    itemsSold += item.quantity;
                });
            });
            
            const avgTransaction = transactions > 0 ? revenue / transactions : 0;
            
            document.getElementById('sales-today-items-sold').textContent = itemsSold;
            document.getElementById('sales-today-revenue').textContent = formatCurrency(revenue);
            document.getElementById('sales-today-transactions').textContent = transactions;
            document.getElementById('sales-today-avg-transaction').textContent = formatCurrency(avgTransaction);
            
            const dateObj = new Date(selectedDate);
            document.getElementById('sales-today-date').textContent = formatDate(dateObj);
            
            document.getElementById('sales-tracker-loading').style.display = 'none';
        }
        
        function startBarcodeScanner() {
            const barcodeScannerContainer = document.getElementById('barcode-scanner-container');
            const barcodeScannerControls = document.getElementById('barcode-scanner-controls');
            const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
            const productBarcodeInput = document.getElementById('product-barcode');
            
            barcodeScannerContainer.style.display = 'block';
            barcodeScannerControls.style.display = 'flex';
            scanBarcodeBtn.style.display = 'none';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: barcodeScannerContainer,
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                },
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('Failed to initialize barcode scanner', 'error');
                    stopBarcodeScanner();
                    return;
                }
                Quagga.start();
            });
            
            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                productBarcodeInput.value = code;
                stopBarcodeScanner();
                showNotification('Barcode scanned successfully', 'success');
            });
        }
        
        function stopBarcodeScanner() {
            Quagga.stop();
            document.getElementById('barcode-scanner-container').style.display = 'none';
            document.getElementById('barcode-scanner-controls').style.display = 'none';
            document.getElementById('scan-barcode-btn').style.display = 'block';
        }
        
        function init() {
            loadFromLocalStorage();
            loadSyncQueue();
            cleanupDuplicateSales();
            cleanupSyncQueue();
            
            AuthModule.onAuthStateChanged(async (user) => {
                if (user) {
                    if (!currentUser || currentUser.uid !== user.uid) {
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            const userData = userDoc.data();
                            
                            if (userData) {
                                currentUser = {
                                    uid: user.uid,
                                    ...userData
                                };
                                localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                            }
                        } catch (error) {
                            console.error('Error fetching user data:', error);
                        }
                    }
                    
                    showApp();
                } else {
                    showLogin();
                }
            });
            
            switchSection('dashboard');
            checkOnlineStatus();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sales-date-select').value = today;
            document.getElementById('report-date').value = today;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').textContent = 'Please enter both email and password';
                    return;
                }
                
                await AuthModule.signIn(email, password);
            });
            
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const role = document.getElementById('register-role').value;
                
                if (!name || !email || !password || !confirmPassword || !role) {
                    document.getElementById('register-error').style.display = 'block';
                    document.getElementById('register-error').textContent = 'Please fill in all fields';
                    return;
                }
                
                if (password !== confirmPassword) {
                    document.getElementById('register-error').style.display = 'block';
                    document.getElementById('register-error').textContent = 'Passwords do not match';
                    return;
                }
                
                const registerSubmitBtn = document.getElementById('register-submit-btn');
                registerSubmitBtn.classList.add('loading');
                registerSubmitBtn.disabled = true;
                
                const result = await AuthModule.signUp(email, password, name, role);
                
                if (result.success) {
                    document.querySelector('[data-tab="login"]').click();
                    registerForm.reset();
                }
                
                registerSubmitBtn.classList.remove('loading');
                registerSubmitBtn.disabled = false;
            });
            
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabName}-form` || content.id === `${tabName}-content`) {
                            content.classList.add('active');
                        }
                    });
                    
                    document.getElementById('login-error').style.display = 'none';
                    document.getElementById('register-error').style.display = 'none';
                });
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-page');
                    switchSection(section);
                });
            });
            
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    AuthModule.signOut();
                }
            });
            
            document.getElementById('search-btn').addEventListener('click', () => {
                const searchTerm = document.getElementById('product-search').value;
                searchProducts(searchTerm);
            });
            
            document.getElementById('inventory-search-btn').addEventListener('click', () => {
                const searchTerm = document.getElementById('inventory-search').value;
                filterInventory(searchTerm);
            });
            
            document.getElementById('add-product-btn').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.add('active');
            });
            
            document.getElementById('add-inventory-btn').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.add('active');
            });
            
            document.getElementById('save-product').addEventListener('click', addProduct);
            document.getElementById('cancel-add-product').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.remove('active');
            });
            
            document.getElementById('clear-cart-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the cart?')) {
                    clearCart();
                }
            });
            
            document.getElementById('complete-sale-btn').addEventListener('click', () => {
                if (cart.length > 0) {
                    showCheckoutModal();
                }
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('export-report-btn').addEventListener('click', exportSalesReport);
            
            document.getElementById('filter-sales-by-date-btn').addEventListener('click', () => {
                const selectedDate = document.getElementById('sales-date-select').value;
                if (selectedDate) {
                    filterSalesByDate(selectedDate);
                }
            });
            
            document.getElementById('scan-barcode-btn').addEventListener('click', () => {
                startBarcodeScanner();
            });
            
            document.getElementById('stop-scanner-btn').addEventListener('click', () => {
                stopBarcodeScanner();
            });
            
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('active');
                });
            });
            
            document.getElementById('save-store-settings-btn').addEventListener('click', saveStoreSettings);
            document.getElementById('save-system-settings-btn').addEventListener('click', saveSystemSettings);
            document.getElementById('save-analysis-settings-btn').addEventListener('click', saveAnalysisSettings);
            
            document.getElementById('export-sales-btn').addEventListener('click', exportSalesData);
            document.getElementById('export-expenses-btn').addEventListener('click', exportExpensesData);
            document.getElementById('export-all-data-btn').addEventListener('click', exportAllData);
            document.getElementById('import-data-btn').addEventListener('click', importData);
            document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);
            document.getElementById('clear-analysis-data-btn').addEventListener('click', clearAnalysisData);
            
            document.getElementById('top-items-period').addEventListener('change', function() {
                updateTopItems(this.value);
            });
            
            document.getElementById('dashboard-top-items-period').addEventListener('change', function() {
                updateTopItems(this.value, 'dashboard');
            });
            
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-page');
                    switchSection(section);
                });
            });
            
            document.getElementById('complete-checkout').addEventListener('click', completeSale);
            
            document.getElementById('close-add-product-modal').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.remove('active');
            });
            
            document.getElementById('close-checkout-modal').addEventListener('click', () => {
                document.getElementById('checkout-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-checkout').addEventListener('click', () => {
                document.getElementById('checkout-modal').classList.remove('active');
            });
            
            document.getElementById('add-expense-btn').addEventListener('click', addExpense);
            
            window.addEventListener('online', checkOnlineStatus);
            window.addEventListener('offline', checkOnlineStatus);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            }
        });
    </script>
</body>
</html>